---
layout: post
title:  7. Spring Data
date:   2025-07-27 13:50:14 +0900
categories: Java Spring
---

<!--more-->
ğŸš§ ì‘ì—…ì¤‘

## ğŸª› í•œê³„ì 
ë‹¤ì–‘í•œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•˜ë ¤ë©´ DAO ë¥¼ ìˆ˜í–‰í•˜ëŠ” ê°ì²´ë“¤ì„ ì—¬ëŸ¬ê°œ ì •ì˜í•´ì•¼ í•œë‹¤.

## ğŸ“‚ ëª©ì°¨
- [ê°œìš”](#ê°œìš”)
    - [Java Persistence API (JPA)](#java-persistence-api-jpa)
    - [Spring Template](#spring-template)
    - [Repository](#repository)
    - [Spring Data Modules](#spring-data-modules)
- [Spring Boot RDBMS ì—°ë™í•˜ê¸°](#spring-boot-rdbms-ì—°ë™í•˜ê¸°)
    - [Spring Boot Database ìŠ¤í‚¤ë§ˆ ì •ì˜ ë° ì´ˆê¸° ë°ì´í„° ì„¤ì •](#spring-boot-database-ìŠ¤í‚¤ë§ˆ-ì •ì˜-ë°-ì´ˆê¸°-ë°ì´í„°-ì„¤ì •)
    - [Spring Boot MySQL Database](#spring-boot-mysql-database)
        - [properties ì„¤ì •í•˜ê¸°](#properties-ì„¤ì •í•˜ê¸°)
        - [Testing](#testing)
    - [Spring Boot PostgreSQL Database ë¡œ ë³€ê²½í•´ë³´ê¸°](#spring-boot-postgresql-database-ë¡œ-ë³€ê²½í•´ë³´ê¸°)
        - [properties ë¶„ë¦¬í•˜ê¸°](#properties-ë¶„ë¦¬í•˜ê¸°)
        - [Postgre SQL ì‘ì„±](#postgre-sql-ì‘ì„±)
        - [Testing](#testing-1)
- [Spring Data JPA ì‚¬ìš©í•˜ê¸°](#spring-data-jpa-ì‚¬ìš©í•˜ê¸°)
    - [CrudRepository](#crudrepository)
    - [@Entity ì™€ @Table](#entity-ì™€-table)
    - [CrudRepositoryë¥¼ í™œìš©í•œ User Table Schema êµ¬í˜„](#crudrepositoryë¥¼-í™œìš©í•œ-user-table-schema-êµ¬í˜„)
    - [JPA ì™€ sql ì‚¬ì´ì˜ DB ì´ˆê¸°í™” ê³ ì°°](#jpa-ì™€-sql-ì‚¬ì´ì˜-db-ì´ˆê¸°í™”-ê³ ì°°)
        - [Case 1: JPAê°€ í…Œì´ë¸”ì„ ë§Œë“¤ê³ , SQLì€ ì´ˆê¸° ë°ì´í„°ë§Œ ì‚½ì…](#case-1-jpaê°€-í…Œì´ë¸”ì„-ë§Œë“¤ê³ -sqlì€-ì´ˆê¸°-ë°ì´í„°ë§Œ-ì‚½ì…)
        - [Case 2: SQLë¡œ í…Œì´ë¸”ì„ ì •ì˜í•˜ê³ , JPAëŠ” ê±´ë“¤ì§€ ì•ŠìŒ](#case-2-sqlë¡œ-í…Œì´ë¸”ì„-ì •ì˜í•˜ê³ -jpaëŠ”-ê±´ë“¤ì§€-ì•ŠìŒ)
        - [Case 3: ë‘˜ ë‹¤ ì‚¬ìš©í–ˆì§€ë§Œ ì¶©ëŒ ë°œìƒ ê°€ëŠ¥](#case-3-ë‘˜-ë‹¤-ì‚¬ìš©í–ˆì§€ë§Œ-ì¶©ëŒ-ë°œìƒ-ê°€ëŠ¥)
        - [Case 4: í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë§Œ ì´ˆê¸°í™”](#case-4-í…ŒìŠ¤íŠ¸-í™˜ê²½ì—ì„œë§Œ-ì´ˆê¸°í™”)
    - [Testing](#testing-2)
    - [PagingAndSortingRepository ë¥¼ í™œìš©í•œ í˜ì´ì§•](#pagingandsortingrepository-ë¥¼-í™œìš©í•œ-í˜ì´ì§•)
        - [CrudRepository ì™€ PagingAndSortingRepository ë¥¼ í†µí•œ í¬ìŠ¤íŠ¸ ì¡°íšŒ](#crudrepository-ì™€-pagingandsortingrepository-ë¥¼-í†µí•œ-í¬ìŠ¤íŠ¸-ì¡°íšŒ)
        - [@DataJpaTestì™€ @AutoConfigureTestDatabase ë¥¼ í™œìš©í•œ í…ŒìŠ¤íŒ…](#datajpatestì™€-autoconfiguretestdatabase-ë¥¼-í™œìš©í•œ-í…ŒìŠ¤íŒ…)
        - [@DataJpaTest ì™€ @ActiveProfiles ë¥¼ í™œìš©í•œ í…ŒìŠ¤íŒ…](#datajpatest-ì™€-activeprofiles-ë¥¼-í™œìš©í•œ-í…ŒìŠ¤íŒ…)
- [Spring Custom Repository](#spring-custom-repository)
    - [@NoRepositoryBean ì• ë„ˆí…Œì´ì…˜](#norepositorybean-ì• ë„ˆí…Œì´ì…˜)
    - [Spring Data Query](#spring-data-query)
    - [Query Methods](#query-methods)
        - [Query Pattern(Prefix)](#query-patternprefix)
        - [Attribute(Entity Field)](#attributeentity-field)
        - [ì¡°ê±´ í‚¤ì›Œë“œ](#ì¡°ê±´-í‚¤ì›Œë“œ)
        - [ì—°ê²°ì](#ì—°ê²°ì)
        - [ì •ë ¬ ì¡°ê±´](#ì •ë ¬-ì¡°ê±´)
    - [@Query ì• ë„ˆí…Œì´ì…˜](#query-ì• ë„ˆí…Œì´ì…˜)
- [Criteria API]()

---

## ğŸ“š ë³¸ë¬¸

ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì ‘ê·¼í•˜ê¸° ìœ„í•´ ìì£¼ ì“°ëŠ” ë³´ì¼ëŸ¬ í”Œë ˆì´íŠ¸ ì½”ë“œë“¤ì„ ì•ˆì“°ë„ë¡ í•˜ê³ , ë‹¤ì–‘í•œ ë°ì´í„° ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ì„ ì¼ê´€ëœ ì½”ë“œë¡œ ê°€ì ¸ê°€ì„œ ê°œë°œìì—ê²Œ í¸ì˜ì„±ì„ ì œê³µí•¨ê³¼ ë™ì‹œì— ë‹¤ì–‘í•œ ë©”ì„œë“œë¥¼ ì œê³µí•˜ê¸° ìœ„í•œ DAO ìƒì„± í…œí”Œë¦¿ì„ ì§€ì›í•œë‹¤.

ì´ë¥¼ ìœ„í•´ **[JDBC(Java Database Connectivity)](#java-database-connectivity)** ë¥¼ í™œìš©í•´ DBì— ì—°ê²°, ì¿¼ë¦¬ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ **[PreparedStatement](#preparedstatement)**ë¥¼ ì •ì˜ë§Œ í•˜ë©´ ë‚´ë¶€ì ì¸ ë¡œì§ì„ ìë™ìœ¼ë¡œ ì§œì£¼ì–´ì„œ DB ì— ì ‘ê·¼í•˜ëŠ” ì„¸ë¶€ ë¡œì§ë“¤ì„ ë‹¤ ì•ˆì§œì£¼ì–´ë„ ëœë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ìƒì‚°ì„±ì´ ë¹„ì•½ì ìœ¼ë¡œ ëŠ˜ì–´ë‚œë‹¤.

ìš°ì„  ê°œë…ë¶€í„° ë³´ê³  ê°€ì.

### ê°œìš”

#### Java Persistence API (JPA)

JPAëŠ” ìë°” ê°ì²´(Entity)ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ë§¤í•‘í•˜ê¸° ìœ„í•œ **[ORM(Object-Relational Mapping)](#orm)** í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.

ê¸°ë³¸ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤:
> Entity (ìë°” ê°ì²´) â†’ Persistence Provider (ì˜ˆ: Hibernate, EclipseLink) â†’ Database

ìš°ë¦¬ëŠ” JPAê°€ ì •ì˜í•œ **ì¸í„°í˜ì´ìŠ¤(API ëª…ì„¸)**ë¥¼ ì‚¬ìš©í•˜ê³ , ì‹¤ì œ ë™ì‘ì€ Hibernate ë“±ì˜ í¼ì‹œìŠ¤í„´ìŠ¤ ì œê³µìê°€ êµ¬í˜„í•œë‹¤.

ì¦‰, JPAëŠ” í‘œì¤€ì„ ì •ì˜í•˜ê³ , êµ¬í˜„ì²´ëŠ” ì´ë¥¼ ë”°ë¥´ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.

#### Spring Template

**JDBC, JMS(Java Message Service), JNDI** ë“± ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì €ìˆ˜ì¤€ APIì—ì„œëŠ” DB ì—°ê²°, ì˜ˆì™¸ ì²˜ë¦¬, ìì› í•´ì œ ë“±ì˜ **ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ì½”ë“œ**ê°€ ë°˜ë³µì ìœ¼ë¡œ ë°œìƒí•œë‹¤.

Springì€ ì´ëŸ¬í•œ ë°˜ë³µ ì‘ì—…ì„ ì¤„ì´ê¸° ìœ„í•´ **Template ê¸°ë°˜ì˜ ì¶”ìƒí™” í´ë˜ìŠ¤**ë¥¼ ì œê³µí•œë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ `JdbcTemplate`ì€ JDBC APIë¥¼ ì‚¬ìš©í•  ë•Œ í•„ìš”í•œ **ì—°ê²°, ì¿¼ë¦¬ ì‹¤í–‰, ì˜ˆì™¸ ì²˜ë¦¬, ìì› ì •ë¦¬** ë“±ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì¤€ë‹¤.

> ì¦‰, ë³µì¡í•œ try-catch íŒ¨í„´ ì—†ì´ë„ DB ì‘ì—…ì„ ê°„ë‹¨í•˜ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

**JdbcTemplateì˜ ì—­í• **
- DB ì—°ê²° ë° ìì› í•´ì œ ìë™ ì²˜ë¦¬
- **SQLException** â†’ **DataAccessException** (ìŠ¤í”„ë§ ê³µí†µ ì˜ˆì™¸ë¡œ ë³€í™˜)
- SQL ì‹¤í–‰ ë° ê²°ê³¼ ë§¤í•‘ ì§€ì› (`query`, `update` ë“±)

#### Repository

Springì—ì„œ **Repository**ëŠ” ì „í†µì ì¸ **DAO(Data Access Object)**ì˜ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” ê°œë…ì´ë‹¤. `@Repository` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ **ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì„ ì •ì˜**í•˜ë©°, ì´ëŠ” **Spring Data Commons**ì— í¬í•¨ëœ ì—¬ëŸ¬ ì¸í„°í˜ì´ìŠ¤ë“¤ì„ í†µí•´ ê¸°ëŠ¥ì´ í™•ì¥ëœë‹¤.

**Spring Data JPA**ë‚˜ **JdbcTemplate** ê¸°ë°˜ **Repository**ë¥¼ ì‚¬ìš©í•˜ë©´,
- CRUD ë©”ì„œë“œê°€ ìë™ ìƒì„±ë˜ë©°
- ì¿¼ë¦¬ ë©”ì„œë“œ(`findByName`, `countByStatus` ë“±)ë„ ìë™ êµ¬í˜„ëœë‹¤
- DB ì—°ê²°, íŠ¸ëœì­ì…˜ ì²˜ë¦¬, ì˜ˆì™¸(**`DataAccessExcpetion`**ìœ¼ë¡œ ì¼ê´€ëœ ì²˜ë¦¬) ë³€í™˜ ë“±ì€ ëª¨ë‘ ìŠ¤í”„ë§ì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤
- Beanìœ¼ë¡œ ë“±ë¡

> ì¦‰, **ì¸í„°í˜ì´ìŠ¤ë§Œ ì •ì˜í•˜ë©´ êµ¬í˜„ ì—†ì´ë„ ê¸°ë³¸ì ì¸ ë°ì´í„° ì ‘ê·¼ ë¡œì§ì„ ìë™ìœ¼ë¡œ ìƒì„±**í•´ì¤€ë‹¤.

#### Spring Data Modules

- Spring Data Commons
- Spring Data JDBC
- Spring Data JPA
- Spring Data MongoDB
- Spring Data Redis
- Spring Data REST
- Spring Data Apache Casandra
- ...

ë°ì´í„° ì†ŒìŠ¤ë“¤ë§ˆë‹¤ ëª¨ë“ˆë“¤ì´ ìˆì–´ êµ‰ì¥íˆ ë§ì€ ëª¨ë“ˆì´ ìˆë‹¤. ëª¨ë“ˆë“¤ì„ ì´í•´í•˜ê¸° ìœ„í•´ ëª¨ë“ˆì„ ê³„ì¸µì ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤.

- **Spring Data Commons**: Repository, CrudRepository, **PagingAndSortingRepository**
- **Spring Data Sub-modules**: JDBC, JPA, MongoDB, Casandra
- **DB Layer**: JDBC-MySQL, JPA-PostgreSQL, MongoDB-MongoDB, ...

Spring Data CommonsëŠ” Data ì„œë¸Œ ëª¨ë“ˆë“¤ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì¼ê´€ëœ ì¸í„°í˜ì´ìŠ¤ë¥¼ ê°œë°œìì—ê²Œ ì œê³µí•˜ê³ , ì„œë¸Œ ëª¨ë“ˆì€ ê°ê°ì˜ ë‹¤ì–‘í•œ DBì— ì—°ê²°ë˜ì–´ ë°ì´í„° ì†ŒìŠ¤ë§ˆë‹¤ ì½”ë“œ ì°¨ì´ë¥¼ ê°œë°œìê°€ êµ³ì´ ëª°ë¼ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

### Spring Boot RDBMS ì—°ë™í•˜ê¸°

ìš°ì„  JPAë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì˜ì¡´ì„±ì„ ì¶”ê°€í•œë‹¤.

{% highlight java %}
implementation('org.springframework.boot:spring-boot-starter-data-jpa') {
    exclude group: 'com.zaxxer', module: 'HikariCP'
}
{% endhighlight %}

ì—¬ê¸°ì„œ HikariCP ë§ê³  **[Connection Pool](#connection-pool)** ë¡œ ë‹¤ìŒì„ ì„¤ì •í•œë‹¤.

{% highlight java %}
implementation 'org.apache.tomcat:tomcat-jdbc:10.1.20' // ì»¤ë„¥ì…˜ í’€ tomcat jdbc ì‚¬ìš©
{% endhighlight %}

ì»¤ë„¥ì…˜ í’€ì€ ì„œë¹„ìŠ¤ë§ˆë‹¤ ì•Œë§ì€ê±¸ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

#### Spring Boot Database ìŠ¤í‚¤ë§ˆ ì •ì˜ ë° ì´ˆê¸° ë°ì´í„° ì„¤ì •

ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•˜ëŠ” ë¶€ë¶„ì€ `resources/schema.sql`, `resources/data.sql` ì—ì„œ í•  ìˆ˜ ìˆë‹¤. ê·¸ ì „ì— *.sqlì„ ì‚¬ìš©í•˜ë„ë¡ í•˜ê¸° ìœ„í•´ spring ì—ì„œ ë‹¤ìŒ í”„ë¡œí¼í‹°ë¥¼ ì„¤ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.

{% highlight properties %}
# application.properties

# always ë‚´ì¥DB, ì™¸ì¥DBë“  ìƒê´€ ì—†ì´ í•­ìƒ SQL íŒŒì¼ ì‹¤í–‰
# embedded(ê¸°ë³¸ê°’) H2, HSQL ë“±ì˜ ë‚´ì¥ DB ì—ì„œë§Œ SQL íŒŒì¼ ì‹¤í–‰
# never SQL ì´ˆê¸°í™” íŒŒì¼ ì‹¤í–‰ ì•ˆí•¨
spring.sql.init.mode=always

# schema.sql + data.sql ì‚¬ìš©ì„ ëª…ì‹œ
spring.sql.init.schema-locations=classpath:schema.sql
spring.sql.init.data-locations=classpath:data.sql

# Hibernateê°€ í…Œì´ë¸” ë§Œë“¤ì§€ ì•Šë„ë¡ ì„¤ì •
spring.jpa.hibernate.ddl-auto=none

# JPA SQL ì¿¼ë¦¬ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•˜ë„ë¡ í•¨
spring.jpa.show-sql=true
{% endhighlight %}

ìŠ¤í‚¤ë§ˆë¥¼ ì„¤ì •í•œë‹¤.
{% highlight sql %}
// schema.sql
CREATE TABLE IF NOT EXISTS USERS (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100),
  email VARCHAR(100)
);
{% endhighlight %}

ê¸°ë³¸ì ìœ¼ë¡œ í•¸ë“¤ë§ í•  ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.
{% highlight sql %}
// data.sql
INSERT INTO USERS(id, name, email)
SELECT 1, 'Alice', 'alice@example.com'
WHERE NOT EXISTS (SELECT 1 FROM USERS WHERE id = 1);
{% endhighlight %}

ë°ì´í„°ëŠ” ê·¸ëƒ¥ GPT ê°€ ì£¼ëŠ” ì˜ˆì‹œë¡œ í–ˆë‹¤.

#### Spring Boot MySQL Database

ìš°ì„  mysqlì„ ì—°ê²°í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì˜ì¡´ì„±ì„ ì¶”ê°€í•´ì¤˜ì•¼ í•œë‹¤.

{% highlight java %}
runtimeOnly 'mysql:mysql-connector-java:8.0.33'
{% endhighlight %}

dev í™˜ê²½ì—ì„œ MySql serverë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë‹¤ìŒì„ ì…ë ¥í•œë‹¤. **í¬íŠ¸ëŠ” 3306**ì´ë‹¤.

{% highlight bash %}
docker run --name mysql-dev \
  -e MYSQL_ROOT_PASSWORD={password} \
  -e MYSQL_DATABASE={DB ì´ë¦„} \
  -p 3306:3306 \
  -d mysql:8
{% endhighlight %}

##### properties ì„¤ì •í•˜ê¸°
ìì£¼ ì‚¬ìš©ë˜ëŠ” urlê³¼ password ë“±ì„ propertiesì— ì €ì¥í•œë‹¤.

{% highlight properties %}
# mysql.properties
spring.datasource.url=jdbc:mysql://localhost:3306/{DB ì´ë¦„}
spring.datasource.username=root
spring.datasource.password=1234
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
{% endhighlight %}

í•„ìëŠ” `mysql.properties` ë¥¼ ë§Œë“¤ì–´, `application.properties`ì—

{% highlight properties %}
spring.config.import=classpath:mysql.properties
{% endhighlight %}

ë¥¼ ì¶”ê°€í•´ì¤¬ë‹¤.

ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ import í•´ì¤€ë‹¤. Spring Data ì—ì„œ ìì²´ì ìœ¼ë¡œ **DataSource** ë¼ëŠ” ì‹±ê¸€í†¤ ê°ì²´ì— ìš°ë¦¬ê°€ ì •ì˜í•œ spring.datasource í”„ë¡œí¼í‹°ë“¤ì„ í† ëŒ€ë¡œ ìë™ìœ¼ë¡œ **connection** ì„ ìƒì„±í•´ì¤€ë‹¤. ì´ë¥¼ log ì°ì–´ë³´ì.

##### Testing

{% highlight java %}
@Test
public void givenDatasourceAvailableWhenAccessDetailsThenExpectDetails()
        throws SQLException {
    assertThat(dataSource.getClass().getName())
            .isEqualTo("org.apache.tomcat.jdbc.pool.DataSource");
    assertThat(dataSource.getConnection().getMetaData().getDatabaseProductName())
            .isEqualTo("MySQL");
}
{% endhighlight %}

ê¸°ë³¸ì ìœ¼ë¡œ ì˜ˆì™¸ ì²˜ë¦¬ ë˜í•œ ì¼ê´€ì„± ìˆê²Œ ì§€ì›í•´ì£¼ê¸° ë•Œë¬¸ì— ë©”ì„œë“œì— throws **SQLException** ë§Œ ë„£ì–´ì£¼ë©´ exception ì„ ë°›ì„ ìˆ˜ ìˆë‹¤. ì´ì œ ë°ì´í„° ë˜í•œ ë“¤ì–´ê°”ëŠ”ì§€ë¥¼ ì‚´í´ë³´ì.

{% highlight java %}
@Test
public void givenUserWhenGetUserNameByIdThenGetUser() throws Exception {
    try(
            Connection cn = dataSource.getConnection();
            PreparedStatement ps = cn.prepareStatement("SELECT name FROM USERS WHERE id=1");
            ResultSet rs = ps.executeQuery();
    ) {
        if (rs.next())
            assertThat("Alice").isEqualTo(rs.getString("name"));
        else
            fail("No user found with id=1");
    }
}
{% endhighlight %}

í˜„ì¬ JPA Repositoryë¥¼ ë”°ë¡œ ì •ì˜í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—, Spring Data JPAì˜ ê¸°ëŠ¥ì€ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìˆœìˆ˜ JDBC ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆë‹¤.

#### Spring Boot PostgreSQL Database ë¡œ ë³€ê²½í•´ë³´ê¸°

Postgre ì „ìš© db ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„ì‹œ ì„œë²„ë¥¼ ì—°ë‹¤. **í¬íŠ¸ëŠ” 5432** ì´ë‹¤.
{% highlight bash %}
docker run --name postgres-dev \
  -e POSTGRES_USER={username} \
  -e POSTGRES_PASSWORD={password} \
  -e POSTGRES_DB={DB ì´ë¦„} \
  -p 5432:5432 \
  -d postgres:15
{% endhighlight %}

ì˜ì¡´ì„±ì„ ì¶”ê°€í•´ì¤€ë‹¤.
{% highlight java %}
runtimeOnly 'org.postgresql:postgresql'
{% endhighlight %}

##### properties ë¶„ë¦¬í•˜ê¸°
postgre ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ì„¸íŒ… ê°’ì´ ë°”ë€Œì–´ì•¼ í•˜ë¯€ë¡œ postgres, mysql ë³„ë¡œ properties ë¥¼ ë”°ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤. 
{% highlight properties %}
# application-postgres.properties
# DB Initialize
spring.sql.init.schema-locations=classpath:db/postgres/schema.sql
spring.sql.init.data-locations=classpath:db/postgres/data.sql

# DataSource
spring.datasource.url=jdbc:postgresql://localhost:5432/{DB ì´ë¦„}
spring.datasource.username={username}
spring.datasource.password={password}
spring.datasource.driver-class-name=org.postgresql.Driver
{% endhighlight %}

ìœ„ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤ê³  í•´ì„œ ìë™ìœ¼ë¡œ ì°¸ì¡°í•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤. application.propertiesì—ì„œ ë‹¤ìŒì„ ë„£ì–´ì£¼ë©´ ëœë‹¤.
{% highlight properties %}
# application.properties
spring.profiles.active=postgres
{% endhighlight %}
ì´ë ‡ê²Œ ë˜ë©´ db server ê°€ ë°”ë€” ë•Œë§ˆë‹¤ ì´ property ë§Œ ë°”ê¿”ì£¼ë©´ ë  í„°ì´ë‹¤.

##### Postgre SQL ì‘ì„±
{% highlight sql %}
-- shema.sql
CREATE TABLE IF NOT EXISTS USERS (
  id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  name VARCHAR(100),
  email VARCHAR(100)
);
{% endhighlight %}

{% highlight sql %}
-- data.sql
INSERT INTO USERS(id, name, email)
OVERRIDING SYSTEM VALUE
VALUES (1, 'Alice', 'alice@example.com')
ON CONFLICT (id) DO NOTHING;
{% endhighlight %}

##### Testing
{% highlight java %}
@Test
public void givenDatasourceAvailableWhenAccessDetailsThenExpectDetails()
        throws SQLException {
    assertThat(dataSource.getClass().getName())
            .isEqualTo("org.apache.tomcat.jdbc.pool.DataSource");
//		assertThat(dataSource.getConnection().getMetaData().getDatabaseProductName())
//				.isEqualTo("MySQL");
    assertThat(dataSource.getConnection().getMetaData().getDatabaseProductName())
            .isEqualTo("PostgreSQL");
}

@Test
public void givenUserWhenGetUserNameByIdThenGetUser() throws Exception {
    try(
            Connection cn = dataSource.getConnection();
            PreparedStatement ps = cn.prepareStatement("SELECT name FROM USERS WHERE id=1");
            ResultSet rs = ps.executeQuery();
    ) {
        if (rs.next())
            assertThat("Alice").isEqualTo(rs.getString("name"));
        else
            fail("No user found with id=1");
    }
}
{% endhighlight %}

í…ŒìŠ¤íŠ¸ì—ì„œ ìˆ˜ì •í•  ë¶€ë¶„ì€ í•œê°€ì§€ ë¿ì´ë‹¤(ì°¾ì•„ë³´ì•„ë¼).

### Spring Data JPA ì‚¬ìš©í•˜ê¸°

ì½”ë“œì—ì„œë„ ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ëª…ë ¹ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê³ , ì´ë¥¼ JPAë¥¼ í†µí•´ í•œë‹¤ê³  ì‚¬ì „ì— ë³´ì•˜ì„ ê²ƒì´ë‹¤. ì—¬ê¸°ì„œëŠ” ì´ JPAì˜ ê°€ì¥ ê¸°ë³¸ì ì¸ **Persistence Provider** ì˜ **Repository** ë¥¼ ë³¸ë‹¤.

{% highlight java %}
@Indexed
public interface Repository<T, ID> { }
{% endhighlight %}
`Repository` ì¸í„°í˜ì´ìŠ¤ë¥¼ íŒŒë³´ë©´ ì œë„ˆë¦­ íƒ€ì… T, ID ê°€ ìˆìŒì„ ë³¼ ìˆ˜ ìˆë‹¤. ID ëŠ” í–‰ì„ êµ¬ë¶„í•˜ëŠ” ì¦‰, ë ˆì½”ë“œë¥¼ êµ¬ë¶„í•˜ëŠ” ì»¬ëŸ¼ ëª… í˜¹ì€ í•„ë“œ ëª…ì´ë‹¤. TëŠ” ì´ ID ì˜ íƒ€ì…ì„ ì„ ì–¸í•œë‹¤.

í•˜ì§€ë§Œ ë‚´ë¶€ëŠ” ë¹„ì–´ìˆëŠ”ê±¸ ë³¼ ìˆ˜ ìˆëŠ”ë° ì´ë¥¼ **[Marker Interface](#marker-interface)** ë¼ê³  í•œë‹¤.

#### CrudRepository

`Repository`ë¥¼ ìƒì† ë°›ëŠ” `CrudRepository`ë¥¼ ë³´ì. ìì£¼ ì‚¬ìš©í•˜ëŠ” ë†ˆì´ë‹¤.

{% highlight java %}
@NoRepositoryBean
public interface CrudRepository<T, ID> extends Repository<T, ID> {

	<S extends T> S save(S entity);

	<S extends T> Iterable<S> saveAll(Iterable<S> entities);

	Optional<T> findById(ID id);

	boolean existsById(ID id);

	Iterable<T> findAll();

	Iterable<T> findAllById(Iterable<ID> ids);

	long count();

	void deleteById(ID id);

	void delete(T entity);

	void deleteAllById(Iterable<? extends ID> ids);

	void deleteAll(Iterable<? extends T> entities);

	void deleteAll();
}
{% endhighlight %}

ë©”ì„œë“œ ëª…ì€ ì„¤ëª… ì•ˆí•´ë„ ë  ì •ë„ë¡œ ì§ê´€ì ì´ê³  ëª…í™•í•˜ë‹¤. ìœ„ ë©”ì„œë“œë¥¼ ë‹¤ ì§€ì›í•˜ë©°, êµ³ì´ ì´ë¥¼ ìƒì†í•˜ëŠ” êµ¬í˜„ì²´ì— ìœ„ ë©”ì„œë“œë¥¼ ë‹¤ êµ¬í˜„í•´ì•¼ í•˜ëŠ” ìˆ˜ê³ ë¥¼ ëœ ìˆ˜ ìˆë‹¤.

ì´ì œ ì´ë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ë°, JVMì€ DB ìª½ ì„œë²„ì—ì„œ ì •ì˜ëœ ìŠ¤í‚¤ë§ˆë¥¼ ëª¨ë¥´ê¸°ì— Java ë‚´ì—ì„œ í•´ë‹¹ ë ˆì½”ë“œì™€ ë§ë¨¹ëŠ” í´ë˜ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•œë‹¤. ë‹¤ìŒì„ ì •ì˜í•˜ì.

#### @Entity ì™€ @Table

ì—”í‹°í‹°ëŠ” DBì˜ í•œ í…Œì´ë¸”ì— ë§¤í•‘ë˜ëŠ” **ë„ë©”ì¸ ê°ì²´(ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸)**ì´ë©°, ìŠ¤í‚¤ë§ˆì™€ 1:1ë¡œ ëŒ€ì‘ë  ìˆ˜ ìˆë„ë¡ ì •ì˜ëœë‹¤. `USERS` í…Œì´ë¸”ì— ëŒ€ì‘ë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì—”í‹°í‹°ë¥¼ ë§Œë“¤ì–´ë³´ì.

{% highlight java %}
import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "USERS")
@Data
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;
    @Column(length = 100)
    private String name;
    @Column(length = 100, nullable = false)
    private String email;

    public User() {}
    public User(@NonNull String name, @NonNull String email) {
        this.name = name;
        this.email = email;
    }
}
{% endhighlight %}

> NonNull ê³¼ Data ì–´ë…¸í…Œì´ì…˜ì€ í•„ìì˜ [Lombok][lombok] ê¸€ì„ ë³´ì.
> `@NonNull`ê³¼ `@Data`ëŠ” Lombok ì• ë…¸í…Œì´ì…˜ì´ë©°, `@NonNull`ì€ ìƒì„±ì ì¸ìì— nullì´ ë“¤ì–´ì˜¤ì§€ ì•Šë„ë¡ ëŸ°íƒ€ì„ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•œë‹¤.  
> `@Data`ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ **Spring Data JPAëŠ” ìƒì„±ì ê¸°ë°˜ ê°ì²´ ìƒì„±ì„ í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì—**, ëª…ì‹œì  ìƒì„±ìë¥¼ ì„ ì–¸í•´ì£¼ëŠ” ê²ƒì´ ì•ˆì •ì ì´ë‹¤.

MySQL ê¸°ì¤€ìœ¼ë¡œ Java ì˜ íƒ€ì…ê³¼ DB ìŠ¤í‚¤ë§ˆì˜ í•„ë“œ íƒ€ì… ë§¤í•‘ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- INT - Integer, int
- BIGINT - Long
- VARCHAR(n) - String
- CHAR(n) - String
- TEXT, LONGTEXT - String
- BOOLEAN, TINYINT(1) - Boolean / boolean
- DATE - java.time.LocalDate
- DATETIME, TIMESTAMP - javatime.LocalDateTime
- DECIMAL, NUMERIC, FLOAT, DOUBLE - java.math.BigDecimal
- ì´ì§„ ê´€ë ¨ ë°ì´í„° - byte[]

**ì£¼ì˜í•  ì **
> int ëŠ” null ì„ í—ˆìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ ìƒì„±ë˜ëŠ” IDì˜ ê°’ê³¼ ì¶©ëŒ ê°€ëŠ¥ì„±ì´ ìˆë‹¤  
Integerì´ë‚˜ Longì„ ì‚¬ìš©í•˜ì—¬ nullì„ í—ˆìš©í•˜ê³  DB ìì²´ì— ì ‘ê·¼ì´ ë ë•Œ ë¯¸ì§€ì • ìƒíƒœë¡œ ë„£ì–´ì£¼ë©´ DBì—ì„œ ì•Œì•„ì„œ ì •ì˜í•´ì¤„ ê²ƒì´ë‹¤.  
  
ë”°ë¼ì„œ, Longì€ **BIGINT AUTO_INCREMENT** ì™€ë„ ê°™ê³ , Integerì€ **INT AUTO_INCREMENT**ì™€ ê°™ë‹¤. int ì˜ ì‚¬ìš©ì€ ë˜ë„ë¡ ì¼ë°˜ì ì¸ í•„ë“œì—ì„œë§Œ ì‚¬ìš©í•˜ë„ë¡ í•˜ì. ê·¸ë¦¬ê³  ì´ë¥¼ java ì—ì„œ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ `@GeneratedValue(strategy = GenerationType.IDENTITY)`ë¥¼ ì¶”ê°€í•˜ì—¬ í•´ë‹¹ í•„ë“œê°€ AUTO_INCREMENT ì„ì„ íƒ€ í”„ë¡œê·¸ë˜ë¨¸ì™€ ì œ 3ìì—ê²Œ ì•Œë ¤ì£¼ì.  
  
ë˜í•œ, **PK, FK, ëˆ„ì ê°’ì— ëŒ€í•œ í•„ë“œì— ëŒ€í•´ì„œëŠ” Longì„ ì“°ëŠ” ê²ƒ**ì´ ë” ë°”ëŒì§í•˜ë‹¤.

> TEXT ê³„ì—´ì€ ì¸ë±ì‹± ì œí•œì´ ìˆê¸° ë•Œë¬¸ì— ê²€ìƒ‰ í•„ë“œë¡œëŠ” ì‚¬ìš© ì£¼ì˜ê°€ í•„ìš”í•˜ë‹¤.

**GenerationValue**
- GeneratedType.Table: DBì˜ **AUTO_INCREMENTë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ** JPA êµ¬í˜„ì²´ê°€ IDë¥¼ ì§ì ‘ ì¦ê°€ì‹œí‚¤ê¸° ìœ„í•´ ì§ì ‘ í‚¤ ìƒì„± ì „ìš© í…Œì´ë¸”ì„ ë§Œë“¤ì–´ì„œ ì‚¬ìš©, schema ì—ì„œ AUTO_INCREMENTë¥¼ ë¹¼ì•¼ í•¨.
- GeneratedType.Identity: DBì—ì„œ ìƒì„±ëœ ì‹ë³„ì ì»¬ëŸ¼ì—ì„œ ìƒì„±ëœ ê°’ì„ ê¸°ë³¸í‚¤ë¡œ ì‚¬ìš©
- GeneratedType.Sequence: ì´ë¦„ ê·¸ëŒ€ë¡œ JPA êµ¬í˜„ì²´ê°€ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì‹œí€€ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ í‚¤ë¥¼ ìƒì„±í•˜ê³  ì´ë¥¼ ê¸°ë³¸í‚¤ë¡œ ì‚¬ìš©
- GeneratedType.Auto: JPA êµ¬í˜„ì²´ê°€ ê¸°ë³¸ í‚¤ ìƒã……ì–´ ë°©ì‹ì„ ìŠ¤ìŠ¤ë¡œ ê²°ì •

**TIP**
> ì–´ë…¸í…Œì´ì…˜ `@Column` ì— ìì²´ì ìœ¼ë¡œ `length` ë¼ëŠ” ì¸ìë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ”ë° ì´ë¥¼ ì„¤ì •í•´ì£¼ëŠ” ê±¸ë¡œ VARCHAR ì˜ ê¸¸ì´ì™€ ë§¤í•‘ì´ ëœë‹¤.  
  
Javaì—ëŠ” `String`ì´ `null` ê°’ì„ ê°€ì§ˆ ìˆ˜ë„ ìˆëŠ”ë°, ì´ë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ `@Column(nullable = false)` ë¥¼ í•´ì£¼ë©´ ë¬´ì¡°ê±´ ì…ë ¥í•˜ë„ë¡ í•˜ê²Œ í•  ìˆ˜ ìˆë‹¤(`unique` ì¸ìë„ ìˆìŒ).

ì´ì œ ì •ì˜ëœ Entity ë¥¼ Table Schemaì™€ ì—°ê²°ì‹œí‚¤ì.
{% highlight java %}
@Data
@Table(name = "USERS")
public class User {
{% endhighlight %}

ì´ì œ JPA ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì¤€ë¹„ê°€ ëë‚¬ë‹¤(`Repository` ì‚¬ìš© ì¤€ë¹„ ë).

#### CrudRepositoryë¥¼ í™œìš©í•œ User Table Schema êµ¬í˜„

{% highlight java %}
import com.example.study.dao.entity.*;
import org.springframework.stereotype.Repository;
import org.springframework.data.repository.CrudRepository;

@Repository
public interface UserRepository extends CrudRepository<User, Long> { }
{% endhighlight %}

ì´ì œ JPA ì—ì„œ ì œê³µí•˜ëŠ” **CRUD, ì¿¼ë¦¬ ë©”ì„œë“œ**ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤. ë‚˜ë¨¸ì§€ í•„ìš”í•œ ë©”ì„œë“œëŠ” ì„œë¹„ìŠ¤ê°€ ìš”êµ¬í•˜ëŠ” ìƒí™©ì— ë§ì¶° ê·¸ë•Œê·¸ë•Œ ì¶”ê°€í•´ì£¼ëŠ”ê²Œ ë°”ëŒì§í•˜ë‹¤.

#### JPA ì™€ sql ì‚¬ì´ì˜ DB ì´ˆê¸°í™” ê³ ì°°

ì´ì œ í”„ë¡œí¼í‹°ì— ê´€í•´ì„œ ë³´ì. ì•ì„œ ë´¤ë“¯ì´ ìš°ë¦¬ëŠ” sql ë¬¸ì„ í†µí•´ ì´ˆê¸° ë°ì´í„°ë“¤ì„ ì •ì˜í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í–ˆëŠ”ë° ê·¸ë ‡ë‹¤ë©´, ë‹¨ìˆœ SQL íŒŒì¼ì´ ì•„ë‹Œ JPA ìì²´ë¥¼ í†µí•´ì„œë„ ì´ˆê¸° ë°ì´í„°ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ í•˜ëŠ” ì˜ë¬¸ì´ ìƒê¸´ë‹¤.

sqlë¡œ ìˆ˜í–‰í•  ë•Œ, ë‹¤ìŒ properties ë“¤ì„ ì¼ë‹¤:
- `spring.jpa.hibernate.ddl-auto`: JPAê°€ ddlì„ ì–´ë–»ê²Œ ì²˜ë¦¬í•  ì§€ì— ëŒ€í•´ ëª…ì‹œ
    - create-drop ì€ ì—”í‹°í‹°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸” ìƒì„±
    - create ëŠ” ì—”í„°í‹°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒˆ í…Œì´ë¸” ìƒì„±(ê¸°ì¡´ í…Œì´ë¸” ëª¨ë‘ ì‚­ì œ)
    - update ëŠ” ì—”í„°í‹°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ì—…ë°ì´íŠ¸í•˜ë©° ê¸°ì¡´ í…Œì´ë¸”ì´ ìˆë‹¤ë©´ ìˆ˜ì •í•˜ê³  ì—†ìœ¼ë©´ ìƒì„±
    - validate ëŠ” í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ìŠ¤í‚¤ë§ˆê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
    - none ì€ Hibernate ê°€ ì „í˜€ ìŠ¤í‚¤ë§ˆë¥¼ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
- `spring.sql.init.mode`: `schema.sql`/`data.sql` ì‹¤í–‰ ì—¬ë¶€ ì œì–´

ì´ì œ ì´ë¥¼ ì¡°ê¸ˆ ë°”ê¿”ê°€ë©´ì„œ ì¼€ì´ìŠ¤ë§ˆë‹¤ ì–´ë–¤ í”„ë¡œí¼í‹° ê°’ì„ ê°€ì§€ê²Œ í•´ì•¼í• ì§€ ì •ë¦¬í•´ë³´ì.

##### Case 1: JPAê°€ í…Œì´ë¸”ì„ ë§Œë“¤ê³ , SQLì€ ì´ˆê¸° ë°ì´í„°ë§Œ ì‚½ì…

{% highlight properties %}
spring.jpa.hibernate.ddl-auto=create
spring.sql.init.mode=always
{% endhighlight %}

createëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ í…Œì´ë¸”ì„ ëª¨ë‘ **ë“œë¡­ í›„ ì¬ìƒì„±**í•˜ëŠ” ì„¤ì •ì´ë‹¤.  
ì¦‰, ê¸°ì¡´ ë°ì´í„°ëŠ” **ë§¤ë²ˆ ì‚­ì œ**ë˜ë©°, í…ŒìŠ¤íŠ¸ë‚˜ ê°œë°œ ì´ˆê¸°ì—ë§Œ ì‚¬ìš©í•˜ê¸° ì í•©í•˜ë‹¤.

ì´ ì„¤ì •ì—ì„œëŠ” JPAê°€ ì§ì ‘ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•˜ë¯€ë¡œ, `schema.sql`ì€ ë¬´ì‹œë˜ê³  ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.  
ë‹¤ë§Œ `data.sql`ì€ **JPAê°€ í…Œì´ë¸” ìƒì„±ì„ ì™„ë£Œí•œ í›„ì— ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì—** ì´ˆê¸° ë°ì´í„° ì‚½ì… ìš©ë„ë¡œëŠ” ìœ íš¨í•˜ë‹¤.

##### Case 2: SQLë¡œ í…Œì´ë¸”ì„ ì •ì˜í•˜ê³ , JPAëŠ” ê±´ë“¤ì§€ ì•ŠìŒ

{% highlight properties %}
spring.jpa.hibernate.ddl-auto=none
spring.sql.init.mode=always
{% endhighlight %}

SQL íŒŒì¼ì— ëª¨ë“  í…Œì´ë¸”ê³¼ ì´ˆê¸° ë°ì´í„°ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ê´€ë¦¬í•œë‹¤. ë³´í†µ ì‹¤ë¬´ì—ì„œ ë§ì´ ì‚¬ìš©í•œë‹¤.

##### Case 3: ë‘˜ ë‹¤ ì‚¬ìš©í–ˆì§€ë§Œ ì¶©ëŒ ë°œìƒ ê°€ëŠ¥

updateëŠ” JPA ê¸°ì¤€ìœ¼ë¡œ í…Œì´ë¸”ì„ ìˆ˜ì •í•˜ë ¤ê³  ì‹œë„í•˜ë©°, ë™ì‹œì— `schema.sql`ì´ ì ìš©ë˜ë©´
ì„œë¡œì˜ êµ¬ì¡°ê°€ ì¶©ëŒí•  ìˆ˜ ìˆë‹¤. íŠ¹íˆ ì»¬ëŸ¼ ì¤‘ë³µ, íƒ€ì… ë¶ˆì¼ì¹˜ ì‹œ ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥í•˜ë‹¤.

{% highlight properties %}
spring.jpa.hibernate.ddl-auto=update
spring.sql.init.mode=always
{% endhighlight %}

ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë µê³  ì˜ˆì¸¡ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ë¹„ì¶”ì²œ

##### Case 4: í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë§Œ ì´ˆê¸°í™”

ë‚´ì¥ DB ì „ìš©ì´ë‹¤.

{% highlight properties %}
spring.jpa.hibernate.ddl-auto=create
spring.sql.init.mode=embedded
{% endhighlight %}

ë‚´ì¥ DBì¼ ë•Œë§Œ, `schema.sql`, `data.sql`ì´ ì‹¤í–‰ë˜ê³ ,  
ì‹¤ì œ **MySQL**ì´ë‚˜ **PostgreSQL**ì—ì„œëŠ” `schema.sql`, `data.sql`ì´ ë¬´ì‹œëœë‹¤.

ì„œë²„ë¥¼ ì˜¬ë¦¬ê³  ë‚˜ì„œëŠ” JPAë¥¼ ê¸°ì¤€ìœ¼ë¡œ ëŒì•„ê°€ê²Œ ëœë‹¤.

#### Testing

í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê¸° ì „ì— ìœ„ì˜ ê²½ìš°ë“¤ì— ë§ì¶° í”„ë¡œí¼í‹°ë¥¼ ì„¤ì •í•´ì£¼ê¸¸ ë°”ë€ë‹¤.

{% highlight java %}
import com.example.study.dao.entity.*;
import org.junit.jupiter.api.*;
import org.springframework.beans.factory.annotation.*;
import org.springframework.boot.test.context.*;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
public class UserRepositoryTest {

    @Autowired
    UserRepository userRepository;

    @Test
    public void givenCreateUserWhenLoadTheUserThenExpectExistedUser() {
        User user = new User("IU", "1234");

        userRepository.save(user);

        assertEquals("IU", userRepository.findById(1L).orElseThrow(
                () -> new AssertionError("User not found")
        ).getName());
    }

    @Test
    public void givenCreateUserWhenLoadTheUserThenExpectSameUser() {
        User user = new User("Alice", "alice@alice.co.kr"); // ì—¬ê¸°ì„  user id ê°€ null ì´ì§€ë§Œ
        User savedUser = userRepository.save(user); // ì—¬ê¸°ì„œëŠ” user idê°€ ìë™ ì„¤ì •ë¨

        assertEquals(user, savedUser);
    }

    @Test
    public void givenUpdateUserWhenLoadTheUserThenExpectUpdatedUser() {
        User user = userRepository.findById(1L)
                .orElseThrow(() -> new AssertionError("User not found"));

        user.setName("Bob");
        userRepository.save(user);

        User foundUser = userRepository.findById(1L).get();

        assertNotEquals("IU", foundUser.getName());
        assertEquals("Bob", foundUser.getName());
    }

    @Test
    public void givenDeleteUserWhenLoadTheUserThenExpectNoUser() {
        long total = userRepository.count();
        User user = userRepository.findById(1L)
                .orElseThrow(() -> new AssertionError("User not found"));

        userRepository.delete(user);
        assertEquals(total-1,userRepository.count());

        userRepository.deleteAll();
        assertEquals(0L, userRepository.count());
    }
}
{% endhighlight %}

ì „ë¶€ í†µê³¼í•´ì•¼ í•œë‹¤.

#### PagingAndSortingRepository ë¥¼ í™œìš©í•œ í˜ì´ì§•

ì–´ë–¤ ì‡¼í•‘ëª°ì´ë“  ê²Œì‹œë¬¼ë“¤ì´ë˜ 1000ë§Œ ê°œì˜ í¬ìŠ¤íŠ¸ë‚˜ ê¸€ë“¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒì€ êµ‰ì¥íˆ ë¬´ê±°ìš´ ì‘ì—…ì´ë‹¤. ë”°ë¼ì„œ ë§ì€ ì–‘ì˜ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ì˜ê²Œ ë‚˜ëˆ ì„œ ì¡°íšŒí•œë‹¤ë©´ page ë§Œí¼ì˜ ì–‘ë§Œ ì¡°íšŒí•˜ê¸° ë•Œë¬¸ì— íš¨ìœ¨ì ì´ê²Œ ëœë‹¤. ì´ëŸ° ê¸°ìˆ ì„ **Paging** ì´ë¼ê³  í•œë‹¤.

ìŠ¤í”„ë§ ë°ì´í„°ì—ì„œëŠ” `PagingAndSoringRepository` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§€ì›í•˜ë©°, `Repository` ë¥¼ ìƒì† ë°›ëŠ” í´ë˜ìŠ¤ì´ë‹¤.

##### CrudRepository ì™€ PagingAndSortingRepository ë¥¼ í†µí•œ í¬ìŠ¤íŠ¸ ì¡°íšŒ

í•˜ê¸° ì „ì— ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ ë‹¤ë£¨ì. Paging ê¸°ëŠ¥ì„ ê·¹í•œìœ¼ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ê³³ì€ ê²Œì‹œê¸€, ìƒí’ˆ ê¸€ë“¤ ë³´ê¸° ë“±ë“± ì¼ ê²ƒì´ë‹¤. í•„ìëŠ” ê²Œì‹œê¸€ë¡œ Post ì—”í‹°í‹°ë¥¼ ì •ì˜í•œë‹¤. ì •ì˜í•˜ê¸° ì „ì— low-levelì˜ DB ë‹¨ì—ì„œ schema ë¥¼ ì •ì˜í•œë‹¤.

{% highlight mysql %}
DROP TABLE IF EXISTS USERS;
DROP TABLE IF EXISTS POSTS;

CREATE TABLE USERS (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100),
  email VARCHAR(100)
);

CREATE TABLE POSTS (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  created_at DATETIME NOT NULL,
  title VARCHAR(50),
  content TEXT
);
{% endhighlight %}

ì´ˆê¸° ë°ì´í„°ë„ ì‚½ì…í•´ì¤€ë‹¤(ë¬¼ë¡  í•„ìëŠ” `init.mode` ê°€ `never` ì´ì§€ë§Œ ë„£ì–´ì¤¬ë‹¤).

{% highlight java %}
INSERT INTO USERS (name, email)
SELECT 'Alice', 'alice@example.com';

INSERT INTO POSTS (time, title, content)
VALUES (NOW(), 'Spring Boot Intro', 'This is the content of the post.');
{% endhighlight %}

í¬ìŠ¤íŠ¸ë¥¼ ì„ ì–¸í•˜ì.

{% highlight java %}
package com.example.study.dao.entity;

import jakarta.persistence.*;
import lombok.*;

import java.time.*;

@Entity
@Table(name = "POSTS")
@Data
public class Post {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Lob
    @Column(nullable = false)
    private LocalDateTime createdAt;

    @Column(length = 50, nullable = false)
    private String title;

    @Column(nullable = false)
    private String content;

    public Post() {}

    public Post(@NonNull LocalDateTime createdAt, @NonNull String title, @NonNull String content) {
        this.createdAt = createdAt;
        this.title = title;
        this.content = content;
    }
}
{% endhighlight %}

ì´ì œ Repositoryë¥¼ ì„ ì–¸í•´ì¤€ë‹¤.

{% highlight java %}
import com.example.study.dao.entity.*;
import org.springframework.data.repository.*;
import org.springframework.stereotype.Repository;

@Repository
import com.example.study.dao.entity.*;
import org.springframework.data.repository.*;
import org.springframework.stereotype.Repository;

@Repository
public interface PostRepository extends PagingAndSortingRepository<Post, Long>, CrudRepository<Post, Long> { }
{% endhighlight %}

í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì.

{% highlight java %}
import com.example.study.dao.entity.*;
import org.junit.jupiter.api.*;
import org.springframework.beans.factory.annotation.*;
import org.springframework.boot.test.context.*;
import org.springframework.data.domain.*;

import java.time.*;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
class PostRepositoryTest {
    @Autowired
    PostRepository postRepository;

    @Test
    void readPostWhenLoadThePostThenExpectExistedPost() {
        // given
        Post post1 = new Post(
                LocalDateTime.of(2025, 7, 3, 10, 0),
                "Spring Boot Intro", "Introduction to Spring Boot"
        );
        Post post2 = new Post(
                LocalDateTime.of(2025, 7, 3, 11, 0),
                "JPA Basics", "Learn JPA with Spring"
        );
        Post post3 = new Post(
                LocalDateTime.of(2025, 7, 3, 12, 0),
                "Testing with JUnit", "Unit testing guide"
        );
        Post post4 = new Post(
                LocalDateTime.of(2025, 7, 3, 13, 0),
                "REST API", "Building REST APIs"
        );
        Post post5 = new Post(
                LocalDateTime.of(2025, 7, 3, 14, 0),
                "Spring Security", "Securing applications"
        );
        Post post6 = new Post(
                LocalDateTime.of(2025, 7, 3, 15, 0),
                "Advanced JPA", "Advanced JPA techniques"
        );
        postRepository.saveAll(List.of(post1, post2, post3, post4, post5, post6));
        Pageable pageable = PageRequest.of(0, 5);

        // when
        Page<Post> page = postRepository.findAll(pageable);
        assertEquals(0, page.getNumber());
        assertEquals(5, page.getSize());
        assertEquals(5, page.getNumberOfElements());
        assertEquals(6, page.getTotalElements());

        // then
        List<Post> posts = page.getContent();
        assertTrue(posts.stream().anyMatch(post ->
                        post.getId().equals(1L) && post.getTitle().equals("Spring Boot Intro")),
                "IDê°€ 1ì´ê³  ì œëª©ì´ 'Spring Boot Intro'ì¸ Postê°€ ì¡´ì¬í•´ì•¼ í•œë‹¤.");
    }
}
{% endhighlight %}


##### @DataJpaTestì™€ @AutoConfigureTestDatabase ë¥¼ í™œìš©í•œ í…ŒìŠ¤íŒ…

ìš°ë¦¬ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œ í•­ìƒ `IoC` ì— `Bean` ì„ ì „ë¶€ ë“±ë¡í•˜ê³ , ë‹¤ ë“±ë¡ëœ í›„ì—ì•¼ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê²Œ ëœë‹¤. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì— ëŒ€í•´ì„œëŠ” í…ŒìŠ¤íŠ¸ í•  ì»´í¬ë„ŒíŠ¸ì™€ ì˜ì¡´ì ì¸ ì»´í¬ë„ŒíŠ¸ë§Œ ì˜¬ë¦¬ë©´ã„· ë˜ì§€ë§Œ, ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ê¹Œì§€ ì˜¬ë ¤ë²„ë¦¬ê¸° ë•Œë¬¸ì— êµ‰ì¥íˆ ë¹„íš¨ìœ¨ì ì´ë‹¤. ë”°ë¼ì„œ ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ Spring ì—ì„œëŠ” Data ì— ëŒ€í•œ ì»´í¬ë„ŒíŠ¸ ë¼ë¦¬ì˜ í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ë¥¼ êµ¬ë¶„ì‹œì¼œì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜ì„ ì§€ì›í•´ì¤€ë‹¤.

`DataJpaTest` ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì–´ë…¸í…Œì´ì…˜ì„ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ë ˆë²¨ì— ë¶™ì—¬ì¤€ë‹¤.

{% highlight java %}
@DataJpaTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
{% endhighlight %}

ì—¬ê¸°ì„œ `AutoConfigureTestDatabase` ì˜ ì—­í• ì€ ê¸°ë³¸ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ìˆ˜ì¤€ì—ì„œì˜ DBëŠ” In-memory ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— ì´ê±¸ ì°¸ì¡°í•˜ëŠ” í”„ë¡œí¼í‹°ë¥¼ ë¹„í™œì„±í™” í•´ì£¼ì–´ì•¼ í•œë‹¤. ì´ëŠ” `AutoConfigureTestDataBase` ë¥¼ í†µí•´ í•´ë‹¹ ì¸ë©”ëª¨ë¦¬ DB ë¡œì˜ ëŒ€ì²´ë¥¼ ë¹„í™œì„±í™”í•´ì£¼ëŠ” í”„ë¡œí¼í‹°ë¥¼ ë„£ì–´ì£¼ë©´ `application.properties` ì˜ DB êµ¬ì„± ì„¤ì •ì„ ë”°ë¥´ê²Œ ëœë‹¤.

##### @DataJpaTest ì™€ @ActiveProfiles ë¥¼ í™œìš©í•œ í…ŒìŠ¤íŒ…

ìŠ¤í”„ë§ ë°ì´í„°ì—ì„œ ìë™ìœ¼ë¡œ ì„¤ì •í•´ì£¼ëŠ” í…ŒìŠ¤íŠ¸ í™˜ê²½ìœ¼ë¡œ í•˜ê¸°ê°€ ì‹«ì„ ë•Œ, properties ê°€ ì´ë¯¸ test í™˜ê²½ì— ëŒ€í•œ êµ¬ì„± ì„¤ì • properties íŒŒì¼ì´ ìˆì„ ë•ŒëŠ” ë‹¤ìŒ ì–´ë…¸í…Œì´ì…˜ @ActiveProfiles ì„ ì‚¬ìš©í•˜ì—¬ ìš°ë¦¬ê°€ db properties ë¥¼ ì„¤ì •ë§Œìœ¼ë¡œ ë°”ê¾¸ ë“¯ì´ ì—¬ê¸°ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

{% highlight java %}
import ...

@DataJpaTest
@ActiveProfiles("test") // application-test.properties ë¡œë“œ
public class PostRepositoryTest {
    ...
}
{% endhighlight %}

ì´ì œ `application-test.properties` ë¥¼ ì„¤ì •í•´ì£¼ë„ë¡ í•˜ì.

### Spring Custom Repository

ì‹¤ë¬´ì—ì„œëŠ” `CRUD` ê¸°ëŠ¥ë“¤ ì¤‘ì— frontì—ê²Œ êµ³ì´ ë…¸ì¶œí•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” APIëŠ” ìˆ¨ê²¨ì•¼ í•œë‹¤. ìŠ¤í”„ë§ ë°ì´í„°ì˜ ë ˆí¬ì§€í† ë¦¬ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë„ë©”ì¸ ê°ì²´ë¥¼ ê´€ë¦¬í•˜ì§€ë§Œ, ì´ ì¸í„°í˜ì´ìŠ¤ë“¤ì„ ìš”êµ¬ì‚¬í•­ì— ë§ê²Œ êµ¬í˜„ì‹œí‚¤ë„ë¡ í•œë‹¤.

ì´ëŠ” ê·¼ë³¸ì ì¸ `Repository` ë¥¼ ë¨¼ì € ìƒì†í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬, ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ create, read ë§Œ êµ¬í˜„í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ê·¼ë³¸ `repository` ë¥¼ ì •ì˜í•  ìˆ˜ ìˆë‹¤.

{% highlight java %}
import org.springframework.data.repository.*;

public interface BaseRepository<T, ID> extends Repository<T, ID> {
    <S extends T> S save(S entity);
    Iterable<T> findAll();
}

{% endhighlight %}

#### @NoRepositoryBean ì• ë„ˆí…Œì´ì…˜
ì—¬ê¸°ì„œ ìœ„ì²˜ëŸ¼ interfaceë¥¼ ì„ ì–¸í•˜ê³  ì„œë¹„ìŠ¤ë¥¼ êµ¬ë™í•˜ë©´ `BaseRepository` ë¼ëŠ” ë¹ˆì´ ìƒì„±ë  ê²ƒì´ë‹¤. ì¦‰ êµ¬í˜„ì²´ê°€ ë§Œë“¤ì–´ì§„ë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ `@NoRepositoryBean` ì• ë„ˆí…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ì„œ ì´ë¥¼ ë‚´ë ¤ì£¼ì.

{% highlight java %}
package com.example.study.dao;

import org.springframework.data.repository.*;

public interface BaseRepository<T, ID> extends Repository<T, ID> {
    <S extends T> S save(S entity);
    Iterable<T> findAll();
}
{% endhighlight %}

### Spring Data Query

ìŠ¤í”„ë§ ë°ì´í„°ì—ì„œëŠ” `Repository` ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ë‹¤ì–‘í•œ ê¸°ë³¸ `CRUD` ì¿¼ë¦¬ë¥¼ ì œê³µí•´ì£¼ì§€ë§Œ, ì´ë³´ë‹¤ ë” ë§ê³  ë‹¤ì–‘í•œ ì¿¼ë¦¬ë“¤ì„ ì •ì˜í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆë‹¤. ì—”í‹°í‹°ì˜ í”„ë¡œí¼í‹°ì— ì¡°ê±´ì„ ê±¸ì–´ì„œ ì¡°íšŒí•˜ê±°ë‚˜ í•˜ë‚˜ ì´ìƒì˜ í”„ë¡œí¼í‹°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ ì¡°íšŒ ê°™ì€ ê²ƒë„ í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆë‹¤. ìŠ¤í”„ë§ ë°ì´í„°ëŠ” ë‹¤ìŒ ë‘ ê°€ì§€ ë°©ë²•ì„ ì§€ì›í•œë‹¤.

- Query Method: ì¸í„°í˜ì´ìŠ¤ì— ë©”ì„œë“œì˜ ì´ë¦„ì„ íŒ¨í„´ì— ë§ê²Œ ì‘ì„±í•˜ë©´ ìŠ¤í”„ë§ ë°ì´í„°ê°€ ì•Œì•„ì„œ íŒŒì‹±í•˜ì—¬ ë§ëŠ” ì¿¼ë¦¬ ë§Œë“¤ì–´ëƒ„
- ì„ ì–¸ì  Query: í•„ìš”í•œ ì¿¼ë¦¬ë¬¸ì„ ì§ì ‘ ì‘ì„±í•´ì„œ ì „ë‹¬í•´ì£¼ë©´ ìŠ¤í”„ë§ ë°ì´í„°ê°€ ì´ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰

#### Query Methods

Query Methods ëŠ” ìŠ¤í”„ë§ ë°ì´í„°ì—ì„œ ì£¼ëŠ” íŒ¨í„´ë§Œ ì˜ ë”°ë¥´ë„ë¡ ë©”ì„œë“œë¥¼ ì •ì˜í•˜ë©´ ì•Œì•„ì„œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•œë‹¤.

> \[ì¿¼ë¦¬ íŒ¨í„´]\[ì†ì„± ì´ë¦„]\[ì¡°íšŒ í‚¤ì›Œë“œ]\[ì—°ê²°ì]\[ì¡°ê±´]

ë‹¤ìŒ ê·œì¹™ì„ ê°€ì§€ë©°, ë³´í†µ ë§¨ ì•ì˜ ì¿¼ë¦¬ íŒ¨í„´ì—ëŠ” ë‹¤ìŒì´ ì˜¬ ìˆ˜ ìˆë‹¤.

##### Query Pattern(Prefix)

| ì¿¼ë¦¬ íŒ¨í„´(Prefix) | ì„¤ëª… |
|-------------------|------|
| `findBy`          | ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë¥¼ ì¡°íšŒí•¨ (ê°€ì¥ ì¼ë°˜ì ) |
| `getBy`           | `findBy`ì™€ ìœ ì‚¬í•˜ì§€ë§Œ, ë°˜ë“œì‹œ ê²°ê³¼ê°€ ìˆì–´ì•¼ í•¨ì„ ì•”ì‹œ |
| `readBy`          | `findBy`ì™€ ìœ ì‚¬, ì½ê¸° ë™ì‘ ê°•ì¡° |
| `queryBy`         | ì¿¼ë¦¬ ìˆ˜í–‰ì˜ ì˜ë„ë¥¼ ê°•ì¡°í•˜ëŠ” í‘œí˜„ |
| `countBy`         | ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ì˜ ê°œìˆ˜ë¥¼ ë°˜í™˜ |
| `existsBy`        | ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ì˜ ì¡´ì¬ ì—¬ë¶€ë¥¼ ë°˜í™˜ (boolean) |
| `deleteBy`        | ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë¥¼ ì‚­ì œ |
| `removeBy`        | `deleteBy`ì™€ ë™ì¼í•˜ê²Œ ì‘ë™, í‘œí˜„ì˜ ì°¨ì´ë§Œ ìˆìŒ |

> ë°˜í™˜ íƒ€ì…ì— ë”°ë¼ ì—¬ëŸ¬ ê°œ ì¸ì§€ í•˜ë‚˜ì¸ì§€ ì•Œ ìˆ˜ ìˆì§€ë§Œ, ë³´í†µì€ findAll ì²˜ëŸ¼ ì—¬ëŸ¬ê°œê°€ ë°˜í™˜ë˜ë©´ ì‹œê·¸ë‹ˆì²˜ì— `All` ì„ ë¶™ì—¬ ì œ 3ìì˜ í”„ë¡œê·¸ë˜ë¨¸ì—ê²Œ ì•Œë ¤ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤.  
ë˜í•œ Optionalì„ ë°˜í™˜ìœ¼ë¡œ ì¼ë‹¤ëŠ” ê²ƒì€ í•´ë‹¹ íƒ€ì…ì´ 0ê°œ í˜¹ì€ 1ê°œ ì¸ì§€ë¥¼ ë§í•´ì¤€ë‹¤. ì¡´ì¬í•˜ì§€ ì•Šë‹¤ë©´ `.empty()` ë©”ì„œë“œê°€ true ì¼í„°ì´ë‹¤.

##### Attribute(Entity Field)

- CamelCase ë¡œ ì‘ì„±
- ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ

##### ì¡°ê±´ í‚¤ì›Œë“œ

| ì¡°ê±´ í‚¤ì›Œë“œ                     | ì„¤ëª… |
|--------------------------------|------|
| `Is`, `Equals`                 | ê°’ì´ ì¼ì¹˜í•¨ (=) |
| `Between`                      | ë‘ ê°’ ì‚¬ì´ì˜ ë²”ìœ„ |
| `LessThan`, `LessThanEqual`   | ë¯¸ë§Œ, ì´í•˜ ì¡°ê±´ (<, <=) |
| `GreaterThan`, `GreaterThanEqual` | ì´ˆê³¼, ì´ìƒ ì¡°ê±´ (>, >=) |
| `IsNull`, `IsNotNull`         | null ì—¬ë¶€ íŒë‹¨ |
| `Like`, `NotLike`             | SQL LIKE ë¬¸ (ë¶€ë¶„ ì¼ì¹˜) |
| `StartingWith`, `EndingWith`, `Containing` | ë¬¸ìì—´ ì‹œì‘, ë, í¬í•¨ ì—¬ë¶€ (LIKE ê¸°ë°˜) |
| `In`, `NotIn`                 | í¬í•¨/ì œì™¸ëœ ê°’ë“¤ ì§‘í•© (IN ì¡°ê±´) |
| `True`, `False`               | boolean ê°’ ì¡°ê±´ |

##### ì—°ê²°ì

ì„¤ëª… ìƒëµ
- And
- Or

##### ì •ë ¬ ì¡°ê±´

ì„¤ëª… ìƒëµ
- Asc
- Desc

> ì¿¼ë¦¬ë©”ì„œë“œëŠ” ë°˜í™˜ë˜ëŠ” ê²Œ ì—¬ëŸ¬ ê°œë¼ë©´ Iterable, Stream ìœ¼ë¡œ ë°˜í™˜ë˜ì§€ë§Œ, Stream ì„ ì“¸ ë•ŒëŠ” Transactional ì‚¬ìš©ì„ ìœ ì˜í•´ì•¼ í•œë‹¤. ë”°ë¡œ ë‹¤ë£° ìˆ˜ë„ ìˆë‹¤.  
Streamì€ **map-reduce-filter** ë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ë‹¤ë£° ìˆ˜ ìˆë‹¤.

#### Query ì• ë„ˆí…Œì´ì…˜ì„ í™œìš©í•œ ì»¤ìŠ¤í…€ ì¿¼ë¦¬ ì„ ì–¸

ë‘ ë²ˆì§¸ ë°©ë²•ì´ë©°, ë‹¤ì–‘í•œ ì¿¼ë¦¬ë¬¸ ìì²´ë¥¼ ë„£ì–´ ë‹¤ìŒ ì¥ì ì„ ê°€ì ¸ê°ˆ ìˆ˜ ìˆë‹¤.
- íŠ¹ì • DBì— íŠ¹í™”ëœ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ìµœì í™”ëœ ì¿¼ë¦¬ë¥¼ í™œìš©í•˜ê¸° ìœ„í•¨
- ë‘ ê°œ ì´ìƒì˜ í…Œì´ë¸”ì„ ì¡°ì¸í•˜ê¸° ìœ„í•¨

NamedQuery, Query, QueryDSL ì„ ì‚¬ìš©í•´ ì¿¼ë¦¬ë¬¸ì„ ì§ì ‘ ì§€ì •í•  ìˆ˜ ìˆë‹¤. 

##### @NamedQuery ì• ë„ˆí…Œì´ì…˜

ìì¹´ë¥´íƒ€ í¼ì‹œìŠ¤í„´ìŠ¤ ì¿¼ë¦¬ ì–¸ì–´(Jakarta Persistence Query Lang., JPQL) ì„ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ì •ì˜í•œë‹¤. NamedQueryëŠ” ì—”í‹°í‹° í´ë˜ìŠ¤, ì—”í‹°í‹° í´ë˜ìŠ¤ì˜ super í´ë˜ìŠ¤ì— ì •ì˜í•˜ê¸° ë•Œë¬¸ì— ì‹¤ì œ repository í´ë˜ìŠ¤ê°€ í–‰í•´ì•¼ í•˜ëŠ” ì¼ì„ ì´ ì• ë„ˆí…Œì´ì…˜ì„ í†µí•´ ì—”í‹°í‹°ì— í´ë˜ìŠ¤ì— ë¶™ì—¬ë²„ë¦¬ë©´ ì±…ì„ë¶„ë¦¬ê°€ ì•ˆë˜ë©° í”„ë¡œê·¸ë˜ë¨¸ê°€ ì°¾ì§€ë„ ëª»í•  ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ ë‹¤ì–‘í•œ ë°©ë²• ì¤‘ì— í•˜ë‚˜ì´ë¯€ë¡œ ì´ê²ƒë„ ì‚´í´ë³¸ë‹¤.

NamedQuery ëŠ” ì¸ìë¡œ ë‹¤ìŒì„ ê°€ì§€ê³  ìˆë‹¤:
- name: ë³´í†µ ì—”í‹°í‹°ëª….ì¿¼ë¦¬ëª… í˜•ì‹ì„ ë”°ë¥´ë„ë¡ ë„£ëŠ”ë‹¤.
- query: JPQL ë¡œ ì‘ì„±ëœ ë¬¸ìì—´ì´ë©°, SQL ê³¼ ìœ ì‚¬í•˜ì§€ë§Œ, í…Œì´ë¸”ê³¼ ì»¬ëŸ¼ ã…ì‹  ì—”í‹°í‹° í´ë˜ìŠ¤ì™€ ê·¸ ì†ì„±ì„ ì°¸ì¡°í•œë‹¤. `?1`, `?2`ì™€ ê°™ì€ ë¬¸ìì—´ì€ `:paramName` ê°™ì€ ì´ë¦„ ê¸°ë°˜ì˜ íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•œë‹¤. ì˜ˆë¥¼ë“¤ì–´ `?email`ì„ ì‚¬ìš©í•œë‹¤ë©´ repository ì—ì„œ API ì„ ì–¸ìœ¼ë¡œ @Param("email") ë¡œ ë§¤í•‘í•  ìˆ˜ ìˆë‹¤.
- lockMode(ì„ íƒ)
- hints(ì„ íƒ)

NamedQueryë¥¼ ì—¬ëŸ¬ê°œ ì“°ê³  ì‹¶ë‹¤ë©´ `@NamedQueries`ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

##### @Query ì• ë„ˆí…Œì´ì…˜

ìœ„ NamedQueryë¥¼ ì‚¬ìš©í•˜ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë„ë©”ì¸ í´ë˜ìŠ¤ê°€ ë°ì´í„° ì €ì¥/ì¡°íšŒì™€ strictly coupling ì´ ë°œìƒí•œë‹¤. ë”°ë¼ì„œ í•´ë‹¹ ì• ë„ˆí…Œì´ì…˜ì˜ ìœ„ì¹˜ë¥¼ ì˜®ê²¨ì•¼ í•œë‹¤. ì´ë•Œ queryë¥¼ í†µí•´ ì‘ì„±í•œë‹¤.

{% highlight java %}
@Repository
public interface PostRepository extends PagingAndSortingRepository<Post, Long>, CrudRepository<Post, Long> {
    @Query("SELECT p FROM 
     p WHERE :keyword IN p.content")
    Iterable<Post> search(@Param("keyword") String keyword);
}
{% endhighlight %}

ìœ„ì™€ ê°™ì´ ì‘ì„±í•œë‹¤ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ì—”í‹°í‹°ëŠ” ì •ì˜ì— ëŒ€í•œ ì±…ì„, ë ˆí¬ì§€í† ë¦¬ëŠ” ì—”í‹°í‹° ê´€ë¦¬ì™€ ìƒì„±, ì‚­ì œì— ëŒ€í•œ ì±…ì„ìœ¼ë¡œ ë¶„ë¦¬ê°€ ë˜ë©°, ê°€ë…ì„± ì¸¡ë©´ì—ì„œë„ ì—”í‹°í‹°ì™€ ë ˆí¬ì§€í† ë¦¬ ë‘˜ ë‹¤ ì•ˆë³´ì•„ë„ ëœë‹¤. ë§Œì•½ native queryë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥í•˜ë©´ ëœë‹¤.

{% highlight java %}
@Repository
public interface PostRepository extends PagingAndSortingRepository<Post, Long>, CrudRepository<Post, Long> {
    @Query("SELECT p FROM POSTS p WHERE p.content LIKE %:keyword%")
    Iterable<Post> search(@Param("keyword") String keyword);
}
{% endhighlight %}

**â­ï¸ìˆ˜ì •ê³¼ ì‚­ì œì— ëŒ€í•œ ë°ì´í„° ì¼ê´€ì„± ê°€ì ¸ì˜¤ê¸°**

{% highlight java %}
@Modifying
@Transactional
@Query("UPDATE POSTS p set p.content=:content WHERE p.id=:id")
int updateCourseRatingByName(@Param("id") Long id, @Param("content") String content);
{% endhighlight %}

- @Modifying ì• ë„ˆí…Œì´ì…˜: @Query ì• ë„ˆí…Œì´ì…˜ê³¼ ê°™ì´ ì“°ë©°, ì •ì˜ëœ ì¿¼ë¦¬ê°€ ì¡°íšŒê°€ ì•„ë‹Œ ìˆ˜ì • ì‘ì—…ì„ í•œë‹¤ëŠ” ê²ƒì„ ì•Œë ¤ì¤€ë‹¤. Modifying ì• ë„ˆí…Œì´ì…˜ì„ ë¶™ì´ì§€ ì•Šì€ ë°ì´í„°ì˜ ë³€ê²½ì´ ìˆ˜ë°˜ë˜ëŠ” ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ `InvalidDataAccessApiUsageException`ì˜ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.

- @Transactional ì• ë„ˆí…Œì´ì…˜: ë°ì´í„° ë³€ê²½(ì˜ˆ: INSERT, UPDATE, DELETE)ê³¼ ê°™ì€ ì‘ì—…ì„ íŠ¸ëœì­ì…˜ ë‹¨ìœ„ë¡œ ê´€ë¦¬í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, ì›ìì„±ì„ ë³´ì¡´í•˜ê²Œ ë˜ì–´ ì‘ì—…ì´ ëª¨ë‘ ì™„ë£Œë˜ê±°ë‚˜(COMMIT) ì·¨ì†Œ(ROLLBACK) ë‹¨ìœ„ë¡œ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

ì¤‘ìš”í•˜ë‹¤. ë‹¤ìŒ ê¸€ì„ ì½ê¸° ì „ì—ëŠ” Java ì˜ persistence íŒ¨í‚¤ì§€ë¥¼ ë³´ê³  ì˜¤ì(Spring ì„¹ì…˜ì—ì„œ ì•ˆë‹¤ë£¸).

### Criteria API

ìœ„ì—ì„œ ì‚¬ìš©ëœ ì• ë„ˆí…Œì´ì…˜ ë‚´ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì¿¼ë¦¬ë¥¼ **JPQL ì¿¼ë¦¬**ë¼ê³  í•œë‹¤. JPQLì„ **ì»´íŒŒì¼ íƒ€ì…ì—ì„œ ê²€ì¦í•  ìˆ˜ ì—†ê¸°** ë•Œë¬¸ì— ì˜ëª» ì‘ì„±í•œ ì¿¼ë¦¬ì— ëŒ€í•œ ë¬¸ì œëŠ” ëŸ°íƒ€ì„ ì—ëŸ¬ë¡œë§Œ ë°œê²¬í•  ìˆ˜ ìˆë‹¤.

ì´ëŸ° ë¬¸ì œì ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œ Criteria APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ë¬¸ì„ ë¬¸ìì—´ì´ ì•„ë‹Œ í”„ë¡œê·¸ë¨ ì†ŒìŠ¤ì²˜ëŸ¼ ì‘ì„±í•˜ë„ë¡ í•˜ì—¬ íƒ€ì… ì•ˆì „ì„±ì„ í™•ë³´í•  ìˆ˜ ìˆë‹¤.

#### EntityManager

JPA ë¥¼ ê´€ë¦¬í•˜ëŠ” ê°ì²´ì¸ EntityManagerëŠ” ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” ì• ë‹¤. `javax.persistence.EntityManager` ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë”°ë¼ì•¼ í•˜ë©°, Springì€ ì´ë¥¼ ì°¸ê³ í•˜ì—¬ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•  ë¿ì´ë‹¤. Springì˜ `EntityManager` ì˜ ê´€ë¦¬ ë²”ìœ„ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

- **Managing Persistence Context**: ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¼ëŠ” ê°œë…ì´ ë‚˜ì˜¤ëŠ”ë° DBì— ì‹¤ì œë¡œ ì €ì¥í•˜ê¸° ì „ì— 1ì°¨ì ìœ¼ë¡œ ì €ì¥í•˜ëŠ” ìºì‹œì™€ ìœ ì‚¬í•˜ë‹¤. ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì²˜ë¦¬ë¥¼ ë‹¤ í•˜ê³  ì´ë¥¼ ì˜¬ë¦¬ê²Œ ëœë‹¤. git ì—ì„œ local ì˜ ì‘ì—…ì´ ëë‚˜ê³  ìµœì¢… ê²°ê³¼ë¥¼ root ì— ì˜¬ë¦¬ëŠ” ê²ƒê³¼ ìœ ì‚¬í•˜ë‹¤.
- Persisting Entity: ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(Persist Context)ê°€ ìˆëŠ”ë° ì—¬ê¸°ì— ì €ì¥ë˜ëŠ” ì—”í‹°í‹°ë“¤ì€ ë³´í†µ DBì— ì €ì¥ë˜ê¸° ì§ì „ ì¤€ë¹„ë¥¼ í•˜ê³  ìˆëŠ” ë°ì´í„°ë“¤ì´ë‹¤.
- **Transaction Context**: `EntityManager`ëŠ” `EntityTransaction` ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ì»¤ë°‹í•˜ë©° ë¡¤ë°±í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. í•˜ì§€ë§Œ ìŠ¤í”„ë§ ê°™ì€ í”„ë ˆì„ì›Œí¬ì—ì„œëŠ” ë³´í†µ ì„ ì–¸ì  íŠ¸ëœì­ì…˜(`@Transactional`) ê´€ë¦¬ë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ê²Œ ëœë‹¤.
- **Query Creation and Excution**: `createQuery()`, `createNamedQuery()`, `createNativeQuery()`, `getCriteriaBuilder()` ë“±ì„ í†µí•´ ë‹¤ì–‘í•œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ê³  ì‹¤í–‰í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ì¡°ì‘í•  ìˆ˜ ìˆë‹¤.

ë°‘ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìˆì–´ì•¼ í•  ê¸°ëŠ¥ì´ê¸°ì— ë”°ë¡œ ëºë‹¤.

- Finding Entity: `find()` ë©”ì„œë“œë¥¼ í†µí•´ PK ë¡œ ì¡°íšŒë¥¼ í•  ìˆ˜ ìˆë‹¤. ë³´í†µ find ë³´ë‹¤ëŠ” `createQuery()`, `createNamedQuery()` ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡°íšŒë¥¼ í•˜ëŠ” ê²½ìš°ê°€ ëŒ€ë¶€ë¶„ì´ë‹¤.
- Updating Entity: Persistence Context ì˜ entity ìƒíƒœê°€ ë³€ê²½ë˜ë©´ íŠ¸ëœì­ì…˜ì´ commit ë  ë•Œ ìë™ìœ¼ë¡œ ë³€ê²½ ì‚¬í•­ì„ ì €ì¥í•˜ê²Œ ëœë‹¤.
- Removing Entity: remove() ë©”ì„œë“œëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ë©°, íŠ¸ëœì­ì…˜ commit ì‹œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œë„ í•´ë‹¹ ì—”í‹°í‹°ê°€ ì‚­ì œë˜ë„ë¡ í•œë‹¤.

ì´ì œ ìœ„ë¥¼ ì°¸ê³ í•˜ì—¬ Criteria Query ë¥¼ ì‘ì„±í•´ë³´ì.

##### EntityManager ì°¸ì¡° ë° CriteriaBuilder ì„ ì–¸

ì¿¼ë¦¬ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œ, ì—”í‹°í‹°ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ì„œ `EntityManager` ë¥¼ ë“¤ê³  ì™€ì•¼ í•œë‹¤. Spring ì˜ Bean ì— ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” `EntityManager` ë¥¼ í…ŒìŠ¤íŠ¸ë˜ `Repository` í´ë˜ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ìª½ì—ì„œ ìë™ì£¼ì…ìœ¼ë¡œ ë“¤ê³ ì˜¤ì.

{% highlight java %}
@Autowired
private EntityManager em;
{% endhighlight %}

ì—”í‹°í‹°ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ, JPAë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì¤€ë¹„ê°€ ëë‚¬ë‹¤. ì´ì œ ì¿¼ë¦¬ë¥¼ ê²€ì¦í•˜ê¸° ìœ„í•œ í´ë˜ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ì. `CriteriaBuilder` ëŠ” ê²€ì¦í•˜ê¸° ìœ„í•œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ê¸°ì— ì•ì„œ ë¶€ë¶„ ë¶€ë¶„ ê° ì¿¼ë¦¬ì˜ ì ˆ(SELECT ì ˆ, WHERE ì ˆ ë“±ë“±) ì˜ ì ˆê³¼ Queryì˜ ë¼ˆëŒ€ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ ë¹Œë” íŒ¨í„´ì´ë‹¤.

ë‹¹ì—°íˆ EntityManager ì˜ `getCriteriaBuilder()` ë©”ì„œë“œë¥¼ í†µí•´ ë“¤ê³  ì˜¬ ìˆ˜ ìˆë‹¤(`EntityManager` ê°€ ë³´í†µ ë‹¤ ê°€ì§€ê³  ìˆë‹¤).

{% highlight java %}
CriteriaBuilder cb = em.getCriteriaBuilder();
{% endhighlight %}

ì¿¼ë¦¬ì˜ ë¼ˆëŒ€ë¥¼ ìƒì„±í•˜ê³  ì‚´ì„ ì±„ì›Œë„£ì.

{% highlight java %}
// ì¿¼ë¦¬ ë¼ˆëŒ€ ìƒì„±
CriteriaQuery<Post> criteriaQuery = cb.createQuery(Post.class);
{% endhighlight %}

ì´ì œ ì‚´ì„ ì±„ì›Œì£¼ì. ì±„ì›Œì£¼ê¸° ì „ì— ì°¸ì¡°ë¥¼ ì‰½ê²Œì‰½ê²Œ ì½”ë”©í•˜ê¸° ìœ„í•´ ì°¸ì¡°ë¥¼ ì €ì¥í•˜ëŠ” ê²ƒì„ ìƒì„±í•œë‹¤. ì—¬ê¸°ì„œ ì°¸ì¡°ì˜ ëª…ì„¸ëŠ” Rootë¡œ ë˜ì–´ìˆë‹¤.
{% highlight java %}
// SELECT * FROM Post ì™€ ê°™ì€ ê²©
Root<Post> root = criteriaQuery.from(Post.class);
{% endhighlight %}

ì¿¼ë¦¬ ì‘ì„±
{% highlight java %}
// SELECT * FROM Post as root WHERE root.title = "HA HA HA Example"
criteriaQuery.select(root)
        // root.get("ì»¬ëŸ¼ëª…") ìœ¼ë¡œ database êµ¬ì„±ìš”ì†Œë¥¼ ë“¤ê³  ì˜¬ ìˆ˜ ìˆë‹¤.
        .where(cb.equal(root.get("title"), "HA HA HA Example"));
{% endhighlight %}

ì—¬ê¸°ì„œ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë” êµ¬ë¶„í•˜ê³  ì‹¶ë‹¤ë©´ where ì ˆì˜ `Predicate` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë„£ëŠ” ê³³ì„ ë¶„ë¦¬ì‹œì¼œì£¼ë©´ ëœë‹¤. ìœ„ë¥¼ ì§€ìš°ê³  ë‹¤ìŒì²˜ëŸ¼ ì¨ë³´ì.

{% highlight java %}
Predicate condition = cb.equal(root.get("title"), "HA HA HA Example");
{% endhighlight %}

ë§Œë“ ê±¸ ì¢…í•©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

{% highlight java %}
    @Test
    void givenSelectWhenLoadedTheDataThenExpectedResult() {
        // Take CriteriaBuilder for handling Entity
        CriteriaBuilder cb = entityManager.getCriteriaBuilder();

        // Define Blueprint for Post CriteriaQuery
        CriteriaQuery<Post> cq = cb.createQuery(Post.class);

        // Write Statement
        Root<Post> p = cq.from(Post.class);
        Predicate condition = cb.equal(p.get("title"), "Hello World");

        // Merge
        cq.select(p)
                .where(condition);
    }
{% endhighlight %}

ì—¬ê¸°ì„œëŠ” íƒ€ì… ê²€ì‚¬ê°€ ìë™ìœ¼ë¡œ ì¼ì–´ë‚˜ê³  JPQL ì¿¼ë¦¬ë¥¼ ì§ì ‘ ë‚  ê²ƒìœ¼ë¡œ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ì¿¼ë¦¬ë¥¼ ë‚ ë¦´ ìˆ˜ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

ì´ì œ ê²€ì¦ ì¿¼ë¦¬ê°€ ì•„ë‹Œ ì‹¤ì œ ì¿¼ë¦¬ë¡œ ë°”ê¾¸ì–´ì„œ ê²°ê³¼ë¥¼ fetch í•´ì˜¤ì.

{% highlight java %}
    @Test
    void givenSelectWhenLoadedTheDataThenExpectedResult() {
        // Take CriteriaBuilder for handling Entity
        CriteriaBuilder cb = entityManager.getCriteriaBuilder();

        // Define Blueprint for Post CriteriaQuery
        CriteriaQuery<Post> cq = cb.createQuery(Post.class);

        // Write Statement
        Root<Post> p = cq.from(Post.class);
        Predicate condition = cb.equal(p.get("title"), "Hello World");

        // Merge
        cq.select(p)
                .where(condition);

        // Actual Query Created
        TypedQuery<Post> query = entityManager.createQuery(cq);

        // Fetch
        assertEquals(query.getResultList().size(), 0);
    }
{% endhighlight %}

ìœ„ì™€ ì‚´ì§ ë‹¤ë¥´ê¸´ í•œë°, ê·¸ë˜ë„ íë¦„ì€ ë™ì¼í•˜ë‹¤.

### Spring Data JPA & QueryDSL

ìœ„ì—ì„œëŠ” Criteria API ì™€ ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ì„ ë´¤ëŠ”ë°, ìœ„ë¥¼ ì§œë©´ì„œ ëŠë‚€ ê²ƒì€ ì½”ë“œê°€ êµ‰ì¥íˆ ê¸´ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ë‹¨ìˆœí•œ ì¡°íšŒ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ ì €ë ‡ê²Œë‚˜ ë§ì€ ì–‘ì˜ ì½”ë“œê°€ í•„ìš”í•˜ë‹¤. ì—¬ê¸°ì„œ ëŒ€ì²´ì¬ë¡œ `QueryDSL`ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê²€í† í•  ìˆ˜ ìˆë‹¤. ì½”ë“œ ì‘ì„±ëŸ‰ì„ ì¤„ì„ê³¼ ë™ì‹œì— ê²€ì¦ ë˜í•œ ì»´íŒŒì¼ íƒ€ì„ì¤‘ì— í•  ìˆ˜ ìˆë‹¤.

ì„œë“œ íŒŒí‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ `QueryDSL`ì€ ë‹¤ìŒ ê²€ì¦ì„ ì§€ì›í•œë‹¤:
- ì—”í‹°í‹° íƒ€ì…ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ê³  í•´ë‹¹ ì—”í‹°í‹°ë¥¼ DBì— ì €ì¥ ê°€ëŠ¥í•œê°€?
- ëª¨ë“  í”„ë¡œí¼í‹°ê°€ ì—”í‹°í‹°ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ê³  í•´ë‹¹ í”„ë¡œí¼í‹°ë¥¼ DBì— ì €ì¥ ê°€ëŠ¥í•œê°€?
- ëª¨ë“  SQL ì—°ì‚°ìì—ëŠ” ì í•©í•œ íƒ€ì…ì´ ì‚¬ìš©ë˜ì—ˆë‚˜?
- ìµœì¢… ì¿¼ë¦¬ê°€ ë¬¸ë²•ì ìœ¼ë¡œ ì˜¬ë°”ë¥¸ê°€?

Spring DataëŠ” QueryDSLì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ `QuerydslPredicateExecutor` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•œë‹¤. ì´ë¥¼ ë³´ì. í•˜ê¸° ì „ì— ìœ„ì— ì¼ë˜ Criteria API ì‚¬ìš©í•œ ì½”ë“œë“¤ì€ ë‹¤ ì§€ì›Œë²„ë¦¬ì :)

#### QueryDSL ì˜ì¡´ì„± ì¶”ê°€

ìš°ì„  ì˜ì¡´ì„± ì¶”ê°€ë¥¼ í•´ì£¼ì.

{% highlight gradle %}
plugins {
    ...
	// ì´ í”ŒëŸ¬ê·¸ì¸ì´ Q-í´ë˜ìŠ¤ ìƒì„± ì‘ì—…ì„ ê°„í¸í•˜ê²Œ í•´ì¤Œ
	id "com.ewerk.gradle.plugins.querydsl" version "1.0.10"
}

dependencies {
    ...
    // querydsl Spring Boot 3.x ì´ìƒê³¼ í˜¸í™˜í•˜ë ¤ë©´ :jakarta classifier ë¥¼ ì‚¬ìš©
	implementation "com.querydsl:querydsl-jpa:5.0.0:jakarta"
	// querydsl Q-class ìƒì„±ì„ ìœ„í•œ ì–´ë…¸í…Œì´ì…˜ í”„ë¡œì„¸ì„œ
	annotationProcessor 'com.querydsl:querydsl-apt:5.0.0:jakarta'
}

// Q í´ë˜ìŠ¤ë“¤ì´ ìƒì„±ë  ë””ë ‰í† ë¦¬ ì§€ì •
def querydslDir = "$buildDir/generated/querydsl"

// QueryDSL Q-í´ë˜ìŠ¤ ìƒì„± ì„¤ì •
// ì´ í”ŒëŸ¬ê·¸ì¸ì€ Q-í´ë˜ìŠ¤ê°€ ìƒì„±ë  ê²½ë¡œë¥¼ ì§€ì •í•˜ê³  í´ë¦° ì‘ì—…ì„ ìë™ìœ¼ë¡œ ì„¤ì •
querydsl {
	jpa = true // JPAë¥¼ ì‚¬ìš©í•  ê²½ìš° trueë¡œ ì„¤ì •
	querydslSourcesDir = querydslDir // Q-í´ë˜ìŠ¤ ìƒì„± ê²½ë¡œ
}
{% endhighlight %}

- com.querydsl:querydsl-apt: ì—”í‹°í‹° í´ë˜ìŠ¤ ë°”íƒ•ìœ¼ë¡œ `Q-íƒ€ì… í´ë˜ìŠ¤`ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ ì• ë„ˆí…Œì´ì…˜ ì²˜ë¦¬ ë„êµ¬, ë§Œì•½ Course í´ë˜ìŠ¤ì— ì• ë„ˆí…Œì´ì…˜ì„ ë„£ì–´ì£¼ë©´ QCourse ê°€ ìƒì„±
- com.querydsl:querydsl-jpa: JPAë¥¼ ì‚¬ìš©í•˜ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ QueryDSL ì„ ì‚¬ìš© ê°€ëŠ¥. ë§Œì•½ MongoDB ë¥¼ ì‚¬ìš©í•˜ë©´ `querydsl-mongodb`ë¡œ ë°”ê¿”ì£¼ë©´ ëœë‹¤.
- com.ewerk.gradle.plugins.querydsl: querydsl ë¸”ëŸ­ì„ ì‚¬ìš©í•˜ì—¬ querydslì˜ q-class ìƒì„± ìœ„ì¹˜ë‚˜ ì„¤ì •ì„ ê°„í¸í•˜ê²Œ í•´ì¤€ë‹¤.

> Q-class ë¼ëŠ” ê²ƒì€ QueryDSLì„ ì‚¬ìš©í•  ë•Œ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ë¥¼ **íƒ€ì…-ì„¸ì´í”„(Type-Safe)**í•˜ê²Œ ì‘ì„±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” íŠ¹ë³„í•œ static í´ë˜ìŠ¤  
> ì—¬ê¸°ì„œ ìƒì„±ëœ Q-classëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ì½”ë“œë¡œë„ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì— outputDirectory í”„ë¡œí¼í‹°ë¡œ ì§€ì •ëœ ë””ë ‰í„°ë¦¬ëŠ” í”„ë¡œì íŠ¸ì˜ ì†ŒìŠ¤ ë””ë ‰í„°ë¦¬ë¡œë„ ì§€ì •ë˜ì–´ì•¼ í•œë‹¤.

#### QuerydslPredicateExecutor ì¸í„°í˜ì´ìŠ¤

ë³´í†µ Repository ì— ìƒì†í•˜ì—¬ QueryDSL ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•œë‹¤.

{% highlight java %}
@Repository
public interface UserRepository extends CrudRepository<User, Long>, QuerydslPredicateExecutor<User> { }
{% endhighlight %}

ì´ì œ Q-class ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒì„ ì…ë ¥í•œë‹¤.

{% highlight shell %}
./gradlew clean build
{% endhighlight %}

> build í›„ì— querydslDir ì˜ ì €ì¥ì†Œì— Q-class ê°€ ìƒì„±ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  
> ì—¬ê¸°ì„œëŠ” ìš°ë¦¬ê°€ ì •ì˜í–ˆë˜ Entity ë“¤ì˜ Q-class ë“¤ì´ ìˆë‹¤.

ìœ„ì²˜ëŸ¼ ì“°ë©°, ë‹¤ìŒ ë©”ì„œë“œë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì›í•´ì¤€ë‹¤.

- findOne
- findAll
- count
- exists
- findBy

CrudRepository ë„ findAllì´ ìˆì§€ë§Œ, ì´ë¥¼ ì˜¤ë²„ë¡œë”©í•œ ë©”ì„œë“œë¥¼ ì œê³µí•œë‹¤. ë“¤ì–´ê°€ëŠ” ì¸ìê°€ Q-class ê´€ë ¨ ë³€ìˆ˜ë“¤ì´ë©°, ì´ëŠ” ë™ì ì´ê³  íƒ€ì…-ì„¸ì´í”„í•œ ì¿¼ë¦¬ ê¸°ëŠ¥ì„ ì œê³µí•˜ê²Œ ëœë‹¤(QPE ì‚¬ìš© ì´ìœ ).

{% highlight java %}
    @Test
    public void givenQueryDSLWhenLoadedTheDataThenExpectedResults() {
        QUser user = QUser.user;

        JPAQuery query1 = new JPAQuery(em);
        query1.from(user).where(user.name.eq("IU"));
        assertEquals(query1.fetch().size(), 0);

        JPAQuery query2 = new JPAQuery(em);
        query2.from(user).where(user.email.eq("ssss@gmail.com").and(user.id.gt(3)));
        assertEquals(query2.fetch().size(), 0);

        assertFalse(userRepository.exists(user.name.eq("IU")));

        OrderSpecifier<Integer> descOrderSpecifier = user.id.desc();
        assertEquals((new ArrayList<> (
                (Collection<User>) userRepository.findAll(descOrderSpecifier)
                )).size(), 0);
    }
{% endhighlight %}


### Projection

ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œë§ˆë‹¤ í…Œì´ë¸”ì˜ ëª¨ë“  ì»¬ëŸ¼ì€ ì¡°íšŒí•  í•„ìš”ê°€ ì—†ë‹¤. ì´ë•Œ, DBì—ëŠ” í”„ë¡œì ì…˜ì´ë¼ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ”ë° ì—¬ê¸°ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ í”„ë¡œì ì…˜, í´ë˜ìŠ¤ ê¸°ë°˜ í”„ë¡œì ì…˜ì´ ìˆë‹¤.

#### ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ í”„ë¡œì ì…˜


#### í´ë˜ìŠ¤ ê¸°ë°˜ í”„ë¡œì ì…˜

ì¸í„°í˜ì´ìŠ¤ ëŒ€ì‹  ë°ì´í„° ì „ì†¡ ê°ì²´ë¼ê³  ë¶ˆë¦¬ëŠ” DTO ê°œë…ì´ ë„ì…ë˜ê³ , ì´ëŠ” ìë°” POJO ê¸°ë°˜ì˜ êµ¬í˜„ì²´ë¡œ DAO ê³„ì¸µê³¼ ì„œë¹„ìŠ¤ ê³„ì¸µ ì‚¬ì´ì—ì„œ ë°ì´í„°ë¥¼ ë‹´ë‹¹í•˜ê²Œ ëœë‹¤(Bridge íŒ¨í„´ì´ë‹¤).

---

## âœ’ï¸ ìš©ì–´

###### ORM

ê°ì²´ì™€ DB í…Œì´ë¸”ì„ ë§¤í•‘í•˜ì—¬ ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‹¤ë£° ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ê¸°ìˆ ì´ë‹¤. SQLì„ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ê°ì²´ë¥¼ í†µí•´ ë°ì´í„° ì¡°ì‘ì´ ê°€ëŠ¥í•˜ë‹¤.

> ì˜ˆ) ìë°” í´ë˜ìŠ¤ì˜ Member ì •ì˜ì™€ DBì˜ member í…Œì´ë¸”ì´ ìë™ìœ¼ë¡œ ë§¤í•‘ë¨

{% highlight java %}
Member member = entityManager.find(Member.class, 1L);
{% endhighlight %}

###### Java Database Connectivity (JDBC)

ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤(RDBMS)ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” **ìë°” í‘œì¤€ API**ì´ë‹¤.  
ìë°” ì½”ë“œì—ì„œ **SQLì„ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê¸°ëŠ¥**ì„ ì œê³µí•˜ëŠ” ì €ìˆ˜ì¤€ì˜ DB ì—°ê²° ë„êµ¬ì´ë‹¤.

{% highlight java %}
String sql = "SELECT * FROM member WHERE id = ?";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setLong(1, 1L);
ResultSet rs = pstmt.executeQuery();
{% endhighlight %}

JPA(ORM)ë¥¼ ì‚¬ìš©í•œ ì½”ë“œì™€ ë¹„êµí•´ ë³´ë©´, JDBCëŠ” SQLê³¼ ì—°ê²° ì½”ë“œ(ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸)ë¥¼ **ì§ì ‘ ëª…ì‹œí•´ì•¼** í•˜ëŠ” ë°˜ë©´, JPAëŠ” ë¯¸ë¦¬ ì •ì˜ëœ ë©”ì„œë“œ(`find`, `persist`, `remove` ë“±)ë¥¼ í†µí•´ **ê°„ê²°í•˜ê³  ì¶”ìƒí™”ëœ ì½”ë“œë¡œ DBë¥¼ ë‹¤ë£° ìˆ˜ ìˆë‹¤.**

###### PreparedStatement

JDBCì—ì„œ **SQL êµ¬ë¬¸ì„ ë¯¸ë¦¬ ì»´íŒŒì¼**í•˜ì—¬ ì‹¤í–‰í•˜ëŠ” ê°ì²´ì´ë‹¤.  
**SQL Injection** ë°©ì§€, ì„±ëŠ¥ í–¥ìƒ ë“±ì˜ ì¥ì ì´ ìˆìœ¼ë©°,  
**ë™ì  íŒŒë¼ë¯¸í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë°”ì¸ë”©**í•  ìˆ˜ ìˆë‹¤.

###### Connection Pool

DBë¥¼ ì—°ê²°í•  ë•ŒëŠ” ë„¤íŠ¸ì›Œí¬ ì—°ê²°, ì‚¬ìš©ì ì¸ì¦, ì„¸ì…˜ ì„¤ì • ë“± ë§ì€ ì‘ì—…ì´ í•„ìš”í•˜ë‹¤. ë§¤ ìš”ì²­ë§ˆë‹¤ ì´ë¥¼ ìƒˆë¡œí•˜ê²Œ ë˜ë©´ ì†ë„ ì €í•˜, ë¦¬ì†ŒìŠ¤ ë‚­ë¹„ê°€ ëœë‹¤.

í•œ ë²ˆë§Œ ë§Œë“¤ì–´ë†“ê³  ì¬ì‚¬ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì»¤ë„¥ì…˜ í’€ì„ ìƒì„±í•˜ë©´, ìŠ¤ë ˆë“œë¥¼ ì—¬ëŸ¬ ê°œ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìë“¤ì´ ì—¬ëŸ¬ëª… ìˆì–´ë„ ìƒˆë¡œ ìƒì„±í•˜ì§€ ì•Šê³ , ìŠ¤ë ˆë“œë¥¼ í•˜ë‚˜ êº¼ë‚´ì„œ ì‚¬ìš©í•˜ê³  ë‹¤ ì‚¬ìš©í•˜ë©´ í’€ì— ë°˜ë‚©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‘ë™í•œë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ DB ì—°ê²° ì†ë„ê°€ í–¥ìƒë˜ë©°, ë¦¬ì†ŒìŠ¤ ì ˆì•½ì´ ëœë‹¤. Spring Bootì—ì„œëŠ” HikariCP ë¼ëŠ” ì»¤ë„¥ì…˜ í’€ì„ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ”ë°, tomcat-jdbcì˜ ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•´ë„ ëœë‹¤. ì·¨í–¥ ì°¨ì´ì´ë‹¤.

> ì˜ˆ: maximum-pool-size í”„ë¡œí¼í‹°ê°€ 10, ìœ ì €ê°€ ë™ì‹œ ì ‘ê·¼ì´ 11ëª…, 1ëª…ì€ ìŠ¤ë ˆë“œ(ìì›)ì´ ë°˜í™˜ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼ í•¨.

###### Marker Interface

ë§ ê·¸ëŒ€ë¡œ 'í‘œì‹' ì¸í„°í˜ì´ìŠ¤ì´ë‹¤. ì•„ë¬´ ë©”ì„œë“œë„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  ì´ëŸ° ì¸í„°í˜ì´ìŠ¤ì´ë‹¤ ë¼ëŠ” ë©”íƒ€ ë°ì´í„°ë§Œ ì£¼ê¸° ìœ„í•´ì„œ ì‚¬ìš©í•œë‹¤. ë³´í†µ java ë¥¼ ëœ¯ì–´ë‚´ë‹¤ ë³´ë©´ ë‹¤ìŒì„ ë³¼ ìˆ˜ ìˆëŠ”ë° ë‹¤ìŒë„ ë§ˆì»¤ ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.

- Serializable
- Cloneable
- Remote

í•´ë‹¹ interfaceë¥¼ í†µí•´ JVM í˜¹ì€ í”„ë ˆì„ì›Œí¬ ë‹¨ì—ì„œ ì¡°ê±´ ë¶„ê¸° ì²˜ë¦¬ê°€ ê°€ëŠ¥í•´ì§€ë¯€ë¡œ ê°€ë…ì„±ê³¼ ë™ì‘ ì œì–´ê°€ ë›°ì–´ë‚˜ë‹¤.

[lombok]: {{ site.baseurl }}/java/2025/06/09/lombok